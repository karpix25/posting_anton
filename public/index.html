<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Automation Dashboard</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 text-gray-800">
  <div id="app" class="min-h-screen p-8">

    <!-- Header -->
    <div class="max-w-6xl mx-auto mb-8 flex justify-between items-center">
      <h1 class="text-3xl font-bold text-blue-600">ðŸš€ Content Automation</h1>
      <button @click="saveConfig" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded shadow">
        Save Changes
      </button>
    </div>

    <!-- Main Content -->
    <div class="max-w-6xl mx-auto bg-white rounded-lg shadow-lg overflow-hidden flex">

      <!-- Sidebar / Tabs -->
      <div class="w-64 bg-gray-50 border-r p-4 space-y-2">
        <button v-for="tab in tabs" :key="tab.id" @click="currentTab = tab.id"
          :class="['w-full text-left px-4 py-2 rounded', currentTab === tab.id ? 'bg-blue-100 text-blue-700 font-semibold' : 'hover:bg-gray-200']">
          {{ tab.name }}
        </button>
      </div>

      <!-- Tab Content -->
      <div class="flex-1 p-8">
        <div v-if="loading" class="text-center text-gray-500">Loading config...</div>

        <div v-else>

          <!-- DASHBOARD TAB -->
          <div v-if="currentTab === 'dashboard'">
            <h2 class="text-2xl font-bold mb-4">Status</h2>
            <div class="grid grid-cols-3 gap-4 mb-8">
              <div class="bg-blue-50 p-4 rounded border border-blue-100">
                <div class="text-sm text-gray-500">Next Run</div>
                <div class="text-lg font-mono">{{ config.cronSchedule }}</div>
              </div>
              <div class="bg-purple-50 p-4 rounded border border-purple-100">
                <div class="text-sm text-gray-500">Active Profiles</div>
                <div class="text-lg font-bold">{{ config.profiles?.length || 0 }}</div>
              </div>
            </div>

            <button @click="triggerRun"
              class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded text-lg font-semibold w-full">
              Run Automation Now
            </button>
          </div>

          <!-- STATS TAB -->
          <div v-if="currentTab === 'stats'">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-2xl font-bold">Analytics & Content Stats</h2>
              <button @click="loadStats"
                class="text-sm bg-gray-200 px-3 py-1 rounded hover:bg-gray-300">Refresh</button>
            </div>

            <div v-if="statsLoading" class="text-center py-8 text-gray-500">Scanning Yandex Disk...</div>
            <div v-else>
              <!-- Overview Cards -->
              <div class="grid grid-cols-2 gap-6 mb-8">
                <div class="bg-blue-50 p-6 rounded-lg border border-blue-100 text-center">
                  <div class="text-gray-500 mb-1">Total Videos Available</div>
                  <div class="text-4xl font-bold text-blue-700">{{ stats.totalVideos }}</div>
                  <div class="text-xs text-blue-400 mt-2">Ready to publish (Yandex Disk)</div>
                </div>
                <div class="bg-green-50 p-6 rounded-lg border border-green-100 text-center">
                  <div class="text-gray-500 mb-1">Published & Deleted</div>
                  <div class="text-4xl font-bold text-green-700">{{ stats.publishedCount }}</div>
                  <div class="text-xs text-green-400 mt-2">Historical count</div>
                </div>
              </div>

              <!-- Categories Breakdown -->
              <h3 class="text-xl font-bold mb-4">Breakdown by Category (Theme)</h3>
              <div class="bg-white border rounded-lg overflow-hidden">
                <table class="w-full">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="text-left p-3 border-b">Category / Folder Theme</th>
                      <th class="text-right p-3 border-b">Count</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="(count, theme) in stats.byCategory" :key="theme"
                      class="border-b last:border-0 hover:bg-gray-50">
                      <td class="p-3 capitalize">{{ theme }}</td>
                      <td class="p-3 text-right font-mono">{{ count }}</td>
                    </tr>
                    <tr v-if="Object.keys(stats.byCategory).length === 0">
                      <td colspan="2" class="p-4 text-center text-gray-400">No categories found or scan failed.</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- SETTINGS TAB -->
          <div v-if="currentTab === 'settings'">
            <h2 class="text-2xl font-bold mb-4">General Settings</h2>

            <div class="mb-4">
              <label class="block mb-2 font-semibold">Cron Schedule</label>
              <input v-model="config.cronSchedule" class="w-full border p-2 rounded" placeholder="0 8 * * *">
            </div>

            <div class="mb-4">
              <label class="block mb-2 font-semibold">Yandex Folders (comma separated)</label>
              <input v-model="foldersInput" @input="updateFolders" class="w-full border p-2 rounded">
            </div>

            <h3 class="text-xl font-bold mt-6 mb-4">Platform Limits</h3>
            <div class="grid grid-cols-3 gap-4">
              <div>
                <label>Instagram</label>
                <input type="number" v-model="config.limits.instagram" class="w-full border p-2 rounded">
              </div>
              <div>
                <label>TikTok</label>
                <input type="number" v-model="config.limits.tiktok" class="w-full border p-2 rounded">
              </div>
              <div>
                <label>YouTube</label>
                <input type="number" v-model="config.limits.youtube" class="w-full border p-2 rounded">
              </div>
            </div>
          </div>

          <!-- PROFILES TAB -->
          <div v-if="currentTab === 'profiles'">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-2xl font-bold">Social Profiles</h2>
              <div class="space-x-2">
                <button @click="syncProfiles"
                  class="text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded hover:bg-blue-200">ðŸ”„ Sync from
                  API</button>
                <button @click="addProfile" class="text-sm bg-gray-200 px-3 py-1 rounded hover:bg-gray-300">+ Add
                  Profile</button>
              </div>
            </div>

            <table class="w-full border-collapse">
              <thead>
                <tr class="bg-gray-100 text-left">
                  <th class="p-2 border">Username (API ID)</th>
                  <th class="p-2 border">Platform</th>
                  <th class="p-2 border">Theme Key</th>
                  <th class="p-2 border">Action</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="(profile, idx) in config.profiles" :key="idx" class="border-t">
                  <td class="p-2"><input v-model="profile.username" class="w-full border p-1 rounded"
                      placeholder="API User ID"></td>
                  <td class="p-2">
                    <select v-model="profile.platform" class="w-full border p-1 rounded">
                      <option value="instagram">Instagram</option>
                      <option value="tiktok">TikTok</option>
                      <option value="youtube">YouTube</option>
                    </select>
                  </td>
                  <td class="p-2"><input v-model="profile.theme_key" class="w-full border p-1 rounded"
                      placeholder="Regex Key"></td>
                  <td class="p-2 text-center">
                    <button @click="removeProfile(idx)" class="text-red-500 hover:text-red-700">Delete</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- CLIENTS TAB -->
          <div v-if="currentTab === 'clients'">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-2xl font-bold">Clients & Prompts</h2>
              <button @click="addClient" class="text-sm bg-gray-200 px-3 py-1 rounded hover:bg-gray-300">+ Add
                Client</button>
            </div>

            <div v-for="(client, idx) in config.clients" :key="idx" class="border p-4 rounded mb-4 bg-gray-50">
              <div class="grid grid-cols-2 gap-4 mb-2">
                <div>
                  <label class="text-sm text-gray-500 block">Client Name</label>
                  <input v-model="client.name" class="w-full border p-2 rounded">
                </div>
                <div>
                  <label class="text-sm text-gray-500 block">Regex Matcher (Folders)</label>
                  <input v-model="client.regex" class="w-full border p-2 rounded font-mono">
                </div>
              </div>
              <div>
                <label class="text-sm text-gray-500 block">AI System Prompt</label>
                <textarea v-model="client.prompt" class="w-full border p-2 rounded h-32 font-mono text-sm"></textarea>
              </div>
              <div class="text-right mt-2">
                <button @click="removeClient(idx)" class="text-red-500 text-sm hover:underline">Remove Client</button>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script>
    const { createApp } = Vue;

    createApp({
      data() {
        return {
          currentTab: 'dashboard',
          tabs: [
            { id: 'dashboard', name: 'Dashboard' },
            { id: 'stats', name: 'Analytics' },
            { id: 'settings', name: 'Settings & Limits' },
            { id: 'profiles', name: 'Social Profiles' },
            { id: 'clients', name: 'Clients (Prompts)' }
          ],
          config: {
            cronSchedule: '',
            yandexFolders: [],
            limits: { instagram: 0, tiktok: 0, youtube: 0 },
            profiles: [],
            clients: []
          },
          stats: {
            totalVideos: 0,
            publishedCount: 0,
            byCategory: {}
          },
          loading: true,
          statsLoading: false,
          foldersInput: ''
        }
      },
      async mounted() {
        await this.loadConfig();
        // Load stats initially too? Or only when tab clicked?
        // Let's load initially for dashboard summary maybe, or just lazy load.
        // Let's lazy load or separate call.
        this.loadStats();
      },
      methods: {
        async loadStats() {
          this.statsLoading = true;
          try {
            const res = await fetch('/api/stats');
            if (res.ok) {
              this.stats = await res.json();
            }
          } catch (e) {
            console.error('Failed to load stats', e);
          } finally {
            this.statsLoading = false;
          }
        },
        async loadConfig() {
          this.loading = true;
          try {
            const res = await fetch('/api/config');
            if (!res.ok) {
              throw new Error(`Server returned ${res.status}`);
            }
            const data = await res.json();
            // Ensure structure and merge with defaults
            this.config = {
              profiles: [],
              clients: [],
              limits: { instagram: 10, tiktok: 10, youtube: 2 },
              yandexFolders: [],
              ...this.config, // Keep existing if any? No, we want server data.
              ...data // Overwrite with server data
            };

            // Explicitly ensure deep objects if missing from server data
            if (!this.config.profiles) this.config.profiles = [];
            if (!this.config.clients) this.config.clients = [];
            if (!this.config.limits) this.config.limits = { instagram: 10, tiktok: 10, youtube: 2 };

            this.foldersInput = (this.config.yandexFolders || []).join(', ');
          } catch (e) {
            console.error('[UI] Failed to load config:', e);
            // alert('Failed to load config (using defaults)');
            // Keep default config structure
          } finally {
            this.loading = false;
          }
        },
        async saveConfig() {
          try {
            await fetch('/api/config', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(this.config)
            });
            alert('Saved successfully!');
          } catch (e) {
            alert('Save failed');
          }
        },
        async triggerRun() {
          if (!confirm('Start automation process now?')) return;
          try {
            await fetch('/api/run', { method: 'POST' });
            alert('Process started!');
          } catch (e) {
            alert('Failed to start process');
          }
        },
        async syncProfiles() {
          console.log('[UI] Sync button clicked');
          try {
            const res = await fetch('/api/profiles/sync');
            const data = await res.json();
            console.log('[UI] Sync response:', data);

            if (data.success && data.profiles) {
              let addedCount = 0;
              // Merge logic: Add if username (API ID) doesn't exist
              data.profiles.forEach(apiProfile => {
                const exists = this.config.profiles.find(p => p.username === apiProfile.username);

                // API returns structured social_accounts. We might want to create entries for each *connected* platform 
                // OR just add the user and let user choose platform. 
                // Simpler: Just add the user. Logic handles separate entries per platform usually if we want distinct queues.
                // But here 'username' in config acts as the API 'user' ID.
                // So we just ensure this 'user' ID is in our list.

                if (!exists) {
                  // Add a generic entry, default to instagram? Or maybe add all detected platforms?
                  // Let's check social_accounts keys
                  const platforms = Object.keys(apiProfile.social_accounts || {});
                  if (platforms.length > 0) {
                    platforms.forEach(plat => {
                      // Check if we have this user+platform combination? 
                      // Current config structure is array of { username, platform, ... }
                      const exactMatch = this.config.profiles.find(p => p.username === apiProfile.username && p.platform === plat);
                      if (!exactMatch) {
                        this.config.profiles.push({
                          username: apiProfile.username,
                          platform: plat,
                          theme_key: '' // User must fill this to match folders
                        });
                        addedCount++;
                      }
                    });
                  } else {
                    // No specific platforms found, just add generic
                    this.config.profiles.push({
                      username: apiProfile.username,
                      platform: 'instagram',
                      theme_key: ''
                    });
                    addedCount++;
                  }
                }
              });

              alert(`Profiles synced! Added ${addedCount} new entries.`);
              // Auto-save? Maybe let user save.
            } else {
              console.error('[UI] Sync failed:', data.error);
              alert('Sync failed: ' + (data.error || 'Unknown error'));
            }
          } catch (e) {
            console.error('[UI] Fetch error:', e);
            alert('Failed to sync profiles (Check console)');
          }
        },
        updateFolders() {
          this.config.yandexFolders = this.foldersInput.split(',').map(s => s.trim()).filter(Boolean);
        },
        addProfile() {
          this.config.profiles.push({ username: '', platform: 'instagram', theme_key: '' });
        },
        removeProfile(idx) {
          this.config.profiles.splice(idx, 1);
        },
        addClient() {
          this.config.clients.push({ name: 'New Client', regex: '', prompt: '' });
        },
        removeClient(idx) {
          this.config.clients.splice(idx, 1);
        }
      }
    }).mount('#app');
  </script>
</body>

</html>