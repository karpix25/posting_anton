<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ContentFlow - Automation Dashboard</title>

    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: rgba(51, 65, 85, 0.6);
            --accent-primary: #3b82f6;
            --accent-secondary: #8b5cf6;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Glassmorphism */
        .glass-card {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        /* Gradient Backgrounds */
        .gradient-blue {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        .gradient-purple {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }

        .gradient-pink {
            background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
        }

        /* Smooth transitions */
        * {
            transition: all 0.2s ease;
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Button Hover Effects */
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
        }

        /* Navigation */
        .nav-link {
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .nav-link:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.05);
        }

        .nav-link.active {
            color: var(--accent-primary);
            background: rgba(59, 130, 246, 0.1);
        }

        /* KPI Cards */
        .kpi-card {
            padding: 1.5rem;
            border-radius: 16px;
            position: relative;
            overflow: hidden;
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom right, rgba(255, 255, 255, 0.1), transparent);
            pointer-events: none;
        }

        .kpi-card:hover {
            transform: scale(1.02);
        }

        /* Number Animation */
        .kpi-number {
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1;
            margin: 0.5rem 0;
        }

        /* Activity Feed */
        .activity-item {
            padding: 1rem;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.03);
            border-left: 3px solid transparent;
        }

        .activity-item:hover {
            background: rgba(255, 255, 255, 0.06);
        }

        .activity-item.success {
            border-left-color: var(--success);
        }

        .activity-item.warning {
            border-left-color: var(--warning);
        }

        /* Focus states */
        button:focus-visible,
        input:focus-visible {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }
    </style>
</head>

<body>
    <div id="app">
        <!-- Top Navigation -->
        <nav class="glass-card" style="margin: 1rem; padding: 1rem 2rem;">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-8">
                    <div class="flex items-center gap-2">
                        <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                            <rect width="32" height="32" rx="8" fill="url(#gradient1)" />
                            <path d="M16 8L24 16L16 24L8 16L16 8Z" fill="white" opacity="0.9" />
                            <defs>
                                <linearGradient id="gradient1" x1="0" y1="0" x2="32" y2="32">
                                    <stop offset="0%" stop-color="#3b82f6" />
                                    <stop offset="100%" stop-color="#8b5cf6" />
                                </linearGradient>
                            </defs>
                        </svg>
                        <span class="text-xl font-bold">ContentFlow</span>
                    </div>

                    <div class="flex gap-2">
                        <button v-for="tab in tabs" :key="tab.id" @click="currentTab = tab.id"
                            :class="['nav-link', { active: currentTab === tab.id }]">
                            {{ tab.name }}
                        </button>
                    </div>
                </div>

                <div class="flex items-center gap-4">
                    <button @click="saveConfig" class="btn-primary" aria-label="Save all configuration changes">
                        üíæ Save Config
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main style="padding: 0 1rem 2rem 1rem; max-width: 1400px; margin: 0 auto;">

            <!-- DASHBOARD TAB -->
            <div v-if="currentTab === 'dashboard'">
                <h1 class="text-3xl font-bold mb-6" style="margin-left: 0.5rem;">Dashboard</h1>

                <!-- KPI Cards -->
                <div class="grid grid-cols-3 gap-6 mb-8">
                    <!-- Video Count -->
                    <div class="kpi-card gradient-blue">
                        <div class="flex items-start justify-between">
                            <div>
                                <div class="text-sm opacity-80 mb-1">üìπ Video Count</div>
                                <div class="kpi-number">{{ stats?.totalVideos || 0 }}</div>
                                <div class="text-sm opacity-70 mt-2">+12% from last week</div>
                            </div>
                            <div class="text-4xl opacity-20">üìπ</div>
                        </div>
                    </div>

                    <!-- Active Profiles -->
                    <div class="kpi-card gradient-purple">
                        <div class="flex items-start justify-between">
                            <div>
                                <div class="text-sm opacity-80 mb-1">üë• Active Profiles</div>
                                <div class="kpi-number">{{ config.profiles?.length || 0 }}</div>
                                <div class="text-sm opacity-70 mt-2">Across 3 platforms</div>
                            </div>
                            <div class="text-4xl opacity-20">üë•</div>
                        </div>
                    </div>

                    <!-- Published Posts -->
                    <div class="kpi-card gradient-pink">
                        <div class="flex items-start justify-between">
                            <div>
                                <div class="text-sm opacity-80 mb-1">‚úÖ Published</div>
                                <div class="kpi-number">{{ stats?.publishedCount || 0 }}</div>
                                <div class="text-sm opacity-70 mt-2">+20% this month</div>
                            </div>
                            <div class="text-4xl opacity-20">‚úÖ</div>
                        </div>
                    </div>
                </div>

                <!-- Activity Feed & Quick Actions -->
                <div class="grid grid-cols-3 gap-6">
                    <!-- Activity Feed (2 columns) -->
                    <div class="col-span-2 glass-card p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold">Recent Activity</h2>
                            <button class="text-sm" style="color: var(--accent-primary)">View All ‚Üí</button>
                        </div>

                        <div class="space-y-3">
                            <div class="activity-item success">
                                <div class="flex items-start gap-3">
                                    <div class="text-2xl">‚úÖ</div>
                                    <div class="flex-1">
                                        <div class="font-medium">Posted to Instagram</div>
                                        <div class="text-sm" style="color: var(--text-secondary)">@beauty_account - 2
                                            minutes ago</div>
                                    </div>
                                    <div class="text-xs" style="color: var(--text-secondary)">14:32</div>
                                </div>
                            </div>

                            <div class="activity-item warning">
                                <div class="flex items-start gap-3">
                                    <div class="text-2xl">‚è∞</div>
                                    <div class="flex-1">
                                        <div class="font-medium">Scheduled for tomorrow</div>
                                        <div class="text-sm" style="color: var(--text-secondary)">@tiktok_profile - 15
                                            minutes ago</div>
                                    </div>
                                    <div class="text-xs" style="color: var(--text-secondary)">14:17</div>
                                </div>
                            </div>

                            <div class="activity-item success">
                                <div class="flex items-start gap-3">
                                    <div class="text-2xl">üì§</div>
                                    <div class="flex-1">
                                        <div class="font-medium">Video uploaded to queue</div>
                                        <div class="text-sm" style="color: var(--text-secondary)">PayWorld brand - 1
                                            hour ago</div>
                                    </div>
                                    <div class="text-xs" style="color: var(--text-secondary)">13:15</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions (1 column) -->
                    <div class="glass-card p-6">
                        <h2 class="text-xl font-semibold mb-4">Quick Actions</h2>
                        <div class="space-y-3">
                            <button @click="triggerRun(false)" class="btn-primary w-full"
                                aria-label="Run full automation cycle">
                                ‚ñ∂Ô∏è Run Automation
                            </button>
                            <button @click="triggerRun(true)" class="btn-secondary w-full"
                                aria-label="Test run with one post per platform">
                                üß™ Test Run (1 post)
                            </button>
                            <button @click="triggerCleanup" class="btn-secondary w-full"
                                style="border-color: var(--error); color: var(--error);"
                                aria-label="Delete all scheduled posts">
                                üóëÔ∏è Cleanup Queue
                            </button>
                            <button @click="loadStats(true)" class="btn-secondary w-full"
                                aria-label="Refresh statistics">
                                üîÑ Refresh Stats
                            </button>
                        </div>
                    </div>
                </div>

                <!-- PUBLISHING STATS WIDGET -->
                <div v-if="publishingStats" class="mt-6 mb-8 glass-card p-6"
                    style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold flex items-center gap-2">
                            üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–π
                        </h3>
                        <button @click="loadPublishingStats" class="btn-secondary py-1 px-3 text-sm">
                            üîÑ –û–±–Ω–æ–≤–∏—Ç—å
                        </button>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-gray-800/50 p-4 rounded-xl border border-gray-700">
                            <div class="text-xs opacity-70 mb-1">–û–∂–∏–¥–∞–µ—Ç—Å—è –ø–æ—Å—Ç–æ–≤</div>
                            <div class="text-2xl font-bold text-blue-400">{{ publishingStats.total_expected_posts || 0
                                }}</div>
                        </div>
                        <div class="bg-gray-800/50 p-4 rounded-xl border border-gray-700">
                            <div class="text-xs opacity-70 mb-1">–í—Å–µ–≥–æ —Å–æ–∑–¥–∞–Ω–æ</div>
                            <div class="text-2xl font-bold text-purple-400">{{ publishingStats.total_actual_posts || 0
                                }}</div>
                        </div>
                        <div class="bg-gray-800/50 p-4 rounded-xl border border-gray-700">
                            <div class="text-xs opacity-70 mb-1">–£—Å–ø–µ—à–Ω–æ</div>
                            <div class="text-2xl font-bold text-green-400">{{ publishingStats.posts_by_status?.success
                                || 0 }}</div>
                        </div>
                        <div class="bg-gray-800/50 p-4 rounded-xl border border-gray-700">
                            <div class="text-xs opacity-70 mb-1">–£—Å–ø–µ—à–Ω–æ—Å—Ç—å</div>
                            <div class="text-2xl font-bold text-cyan-400">{{ publishingStats.avg_success_rate || 0 }}%
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Status Breakdown -->
                        <div class="bg-gray-800/30 p-4 rounded-xl border border-gray-700">
                            <div class="text-sm font-semibold opacity-80 mb-3 border-b border-gray-700 pb-2">–ü–æ —Å—Ç–∞—Ç—É—Å—É:
                            </div>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-amber-400">‚è≥ –í –æ—á–µ—Ä–µ–¥–∏:</span>
                                    <span class="font-bold">{{ publishingStats.posts_by_status?.queued || 0 }}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-blue-400">üîÑ –û–±—Ä–∞–±–æ—Ç–∫–∞:</span>
                                    <span class="font-bold">{{ publishingStats.posts_by_status?.processing || 0
                                        }}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-red-400">‚ùå –û—à–∏–±–∫–∏:</span>
                                    <span class="font-bold">{{ publishingStats.posts_by_status?.failed || 0 }}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Platform Breakdown -->
                        <div class="bg-gray-800/30 p-4 rounded-xl border border-gray-700">
                            <div class="text-sm font-semibold opacity-80 mb-3 border-b border-gray-700 pb-2">–ü–æ
                                –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞–º:</div>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-pink-400">üì∏ Instagram:</span>
                                    <span class="font-bold">{{ publishingStats.posts_by_platform?.instagram || 0
                                        }}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-cyan-400">üéµ TikTok:</span>
                                    <span class="font-bold">{{ publishingStats.posts_by_platform?.tiktok || 0 }}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-red-400">üìπ YouTube:</span>
                                    <span class="font-bold">{{ publishingStats.posts_by_platform?.youtube || 0 }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ERROR LOG WIDGET -->
                <div v-if="errorStats.length > 0" class="glass-card p-6 border-red-900/50"
                    style="background: rgba(40, 10, 10, 0.4);">
                    <h3 class="text-xl font-bold mb-6 text-red-500 flex items-center gap-2">
                        <span>‚ö†Ô∏è –ñ—É—Ä–Ω–∞–ª –û—à–∏–±–æ–∫ (7 –¥–Ω–µ–π)</span>
                        <button @click="loadErrors" class="btn-secondary py-1 px-3 text-xs ml-auto">
                            üîÑ –û–±–Ω–æ–≤–∏—Ç—å
                        </button>
                    </h3>

                    <div class="space-y-4">
                        <div v-for="day in errorStats" :key="day.date"
                            class="border border-red-900/30 rounded-lg overflow-hidden">
                            <!-- Day Header -->
                            <div class="bg-red-900/20 px-4 py-3 font-bold flex justify-between items-center">
                                <span class="text-gray-200">{{ day.date }}</span>
                                <span
                                    class="bg-red-500/20 text-red-300 text-xs px-2 py-1 rounded-full font-bold border border-red-500/30">
                                    –í—Å–µ–≥–æ: {{ day.total }}
                                </span>
                            </div>

                            <!-- Error list -->
                            <div class="divide-y divide-red-900/20 bg-black/20">
                                <div v-for="(err, idx) in day.errors" :key="idx"
                                    class="px-4 py-3 flex justify-between items-center hover:bg-red-900/10 transition-colors">
                                    <div class="flex items-center gap-3">
                                        <span class="text-red-400 font-bold w-8 text-right">{{ err.count }}x</span>
                                        <span class="text-gray-300 font-medium text-sm">{{ err.type }}</span>
                                    </div>
                                    <div class="w-32 bg-gray-800 rounded-full h-1.5 hidden sm:block">
                                        <div class="bg-red-500 h-1.5 rounded-full"
                                            :style="{ width: Math.min(100, (err.count / day.total) * 100) + '%' }">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>


            <!-- STATS (ANALYTICS) PAGE -->
            <div v-if="currentTab === 'stats'">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h1>
                    <button @click="loadStats(true)" aria-label="–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É" class="btn-secondary"
                        style="padding: 0.5rem 1rem;">
                        üîÑ –û–±–Ω–æ–≤–∏—Ç—å
                    </button>
                </div>

                <!-- View Mode Switcher -->
                <div class="glass-card p-4 mb-6">
                    <div class="flex gap-3">
                        <button @click="statsViewMode = 'category'"
                            :class="['px-4 py-2 rounded-lg font-medium transition-all', 
                                     statsViewMode === 'category' ? 'bg-blue-500 text-white' : 'bg-gray-700 hover:bg-gray-600']">
                            –ü–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
                        </button>
                        <button @click="statsViewMode = 'author'"
                            :class="['px-4 py-2 rounded-lg font-medium transition-all',
                                     statsViewMode === 'author' ? 'bg-blue-500 text-white' : 'bg-gray-700 hover:bg-gray-600']">
                            –ü–æ –∞–≤—Ç–æ—Ä–∞–º
                        </button>
                        <button @click="statsViewMode = 'brand'"
                            :class="['px-4 py-2 rounded-lg font-medium transition-all',
                                     statsViewMode === 'brand' ? 'bg-blue-500 text-white' : 'bg-gray-700 hover:bg-gray-600']">
                            –ü–æ –±—Ä–µ–Ω–¥–∞–º
                        </button>
                    </div>
                </div>

                <!-- Analytics Table -->
                <div class="glass-card overflow-hidden">
                    <table class="w-full">
                        <thead
                            style="background: rgba(59, 130, 246, 0.1); border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                            <tr>
                                <th class="text-left p-4 font-semibold">{{ statsHeader }}</th>
                                <th class="text-left p-4 font-semibold">–í–∏–¥–µ–æ</th>
                                <th class="text-left p-4 font-semibold">–ü—Ä–æ—Ñ–∏–ª–∏</th>
                                <th class="text-left p-4 font-semibold">–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="item in currentStatsList" :key="item.name"
                                class="border-b border-gray-700 hover:bg-gray-800 transition-colors">
                                <td class="p-4 font-medium">{{ item.name }}</td>
                                <td class="p-4" style="color: var(--text-secondary)">{{ item.count }}</td>
                                <td class="p-4">
                                    <div class="flex gap-1 flex-wrap">
                                        <span v-for="profile in getProfilesForCategory(item.name)" :key="profile"
                                            class="px-2 py-1 text-xs rounded"
                                            style="background: rgba(59, 130, 246, 0.2); color: var(--accent-primary)">
                                            @{{ profile }}
                                        </span>
                                    </div>
                                </td>
                                <td class="p-4 font-semibold" style="color: var(--success)">
                                    {{ getPublishedCount(item.name) }}
                                </td>
                            </tr>
                            <tr v-if="currentStatsList.length === 0">
                                <td colspan="4" class="p-8 text-center" style="color: var(--text-secondary)">
                                    –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>


            <!-- PROFILES PAGE -->
            <div v-if="currentTab === 'profiles'">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è–º–∏</h1>
                    <div class="flex gap-3">
                        <button @click="loadConfig" class="btn-secondary">
                            üîÑ –û–±–Ω–æ–≤–∏—Ç—å
                        </button>
                    </div>
                </div>

                <!-- Profiles Table -->

                <!-- BULK ACTIONS TOOLBAR -->
                <div v-if="selectedProfiles.length > 0"
                    class="glass-card mb-4 p-4 flex justify-between items-center sticky top-4 z-10"
                    style="background: rgba(59, 130, 246, 0.2); border: 1px solid var(--accent-primary);">

                    <div class="font-bold">
                        –í—ã–±—Ä–∞–Ω–æ: {{ selectedProfiles.length }}
                    </div>

                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-2">
                            <span class="text-sm opacity-80">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</span>
                            <select v-model="bulkThemeKey"
                                class="p-2 rounded bg-gray-900 border border-gray-600 text-white">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>
                                <option v-for="t in availableThemes" :key="t" :value="t">{{ t }}</option>
                            </select>
                            <button @click="applyBulkCategory" class="btn-primary py-1 px-3 text-sm">
                                –ü—Ä–∏–º–µ–Ω–∏—Ç—å
                            </button>
                        </div>

                        <div class="h-8 w-px bg-white/20 mx-2"></div>

                        <div class="flex gap-2">
                            <button @click="toggleBulkEnabled(true)"
                                class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm font-bold">
                                –í–∫–ª—é—á–∏—Ç—å
                            </button>
                            <button @click="toggleBulkEnabled(false)"
                                class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm font-bold">
                                –í—ã–∫–ª—é—á–∏—Ç—å
                            </button>
                        </div>

                        <button @click="selectedProfiles = []"
                            class="ml-4 text-sm underline opacity-70 hover:opacity-100">
                            –°–±—Ä–æ—Å
                        </button>
                    </div>
                </div>

                <div class="glass-card overflow-hidden">
                    <table class="w-full">
                        <thead
                            style="background: rgba(59, 130, 246, 0.1); border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                            <tr>
                                <th class="p-4 w-10">
                                    <input type="checkbox" @change="selectAll($event.target.checked)"
                                        :checked="config.profiles.length > 0 && selectedProfiles.length === config.profiles.length"
                                        class="w-5 h-5 rounded cursor-pointer">
                                </th>
                                <th class="text-left p-4 font-semibold w-12">–°—Ç–∞—Ç—É—Å</th>
                                <th class="text-left p-4 font-semibold">–ü—Ä–æ—Ñ–∏–ª—å</th>
                                <th class="text-left p-4 font-semibold">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                                <th class="text-left p-4 font-semibold">–ü–ª–∞—Ç—Ñ–æ—Ä–º—ã</th>
                                <th class="text-center p-4 font-semibold w-20" title="Limit IG">IG</th>
                                <th class="text-center p-4 font-semibold w-20" title="Limit TT">TT</th>
                                <th class="text-center p-4 font-semibold w-20" title="Limit YT">YT</th>
                                <th class="text-center p-4 font-semibold w-32">–ê–∫—Ç–∏–≤–µ–Ω</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template v-for="group in groupedProfiles" :key="group.name">
                                <!-- Group Header -->
                                <tr class="bg-gray-800/80 hover:bg-gray-700 cursor-pointer transition-colors"
                                    @click="toggleGroup(group.name)">
                                    <td class="p-4 text-center">
                                        <!-- Group Checkbox -->
                                        <input type="checkbox" :checked="isGroupSelected(group.profiles)"
                                            @click.stop="toggleGroupSelection(group.profiles, $event.target.checked)"
                                            class="w-5 h-5 rounded cursor-pointer accent-blue-500">
                                    </td>
                                    <td colspan="8" class="p-4 font-bold text-lg text-blue-200">
                                        <div class="flex items-center gap-2">
                                            <span>{{ isGroupExpanded(group.name) ? '‚ñº' : '‚ñ∂' }}</span>
                                            <span>{{ group.name }}</span>
                                            <span
                                                class="text-sm font-normal text-gray-400 bg-gray-700/50 px-2 py-0.5 rounded-full">
                                                {{ group.profiles.length }}
                                            </span>
                                        </div>
                                    </td>
                                </tr>

                                <!-- Group Profiles (Rows) -->
                                <tr v-if="isGroupExpanded(group.name)" v-for="(profile, idx) in group.profiles"
                                    :key="profile.username"
                                    class="border-b border-gray-700 hover:bg-gray-800 transition-colors"
                                    :class="{ 'opacity-50': profile.enabled === false, 'bg-blue-900/20': selectedProfiles.includes(profile.username) }">
                                    <td class="p-4 text-center pb-8 align-middle">
                                        <input type="checkbox" :checked="selectedProfiles.includes(profile.username)"
                                            @change="toggleSelection(profile.username)"
                                            class="w-5 h-5 rounded cursor-pointer">
                                    </td>
                                    <td class="p-4 text-center text-xl">
                                        {{ profile.enabled !== false ? 'üü¢' : '‚ö´' }}
                                    </td>
                                    <td class="p-4 font-medium">{{ profile.username || '–ë–µ–∑ –∏–º–µ–Ω–∏' }}</td>
                                    <td class="p-4">
                                        <div class="relative">
                                            <input v-model="profile.theme_key" list="themes-list"
                                                class="px-2 py-1 rounded border-0 text-sm w-full"
                                                style="background: rgba(255, 255, 255, 0.05); color: var(--text-primary)"
                                                placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏">
                                            <datalist id="themes-list">
                                                <option v-for="theme in availableThemes" :key="theme" :value="theme">
                                                </option>
                                            </datalist>
                                        </div>
                                    </td>
                                    <td class="p-4">
                                        <div class="flex gap-2 flex-wrap">
                                            <span v-for="platform in (profile.platforms || [])" :key="platform" :class="['px-2 py-1 text-xs rounded font-medium',
                                                    platform === 'instagram' ? 'bg-pink-500/20 text-pink-400' :
                                                    platform === 'tiktok' ? 'bg-cyan-500/20 text-cyan-400' :
                                                    'bg-red-500/20 text-red-400']">
                                                {{ platform === 'instagram' ? 'IG' : platform === 'tiktok' ? 'TT' : 'YT'
                                                }}
                                            </span>
                                        </div>
                                    </td>
                                    <td class="p-4 text-center">
                                        <input type="number" min="0" max="50" v-model.number="profile.instagramLimit"
                                            placeholder="-"
                                            class="w-12 bg-transparent border-b border-gray-600 focus:border-blue-500 text-center text-sm"
                                            title="Instagram –ª–∏–º–∏—Ç (–ø—É—Å—Ç–æ = –≥–ª–æ–±–∞–ª—å–Ω—ã–π)">
                                    </td>
                                    <td class="p-4 text-center">
                                        <input type="number" min="0" max="50" v-model.number="profile.tiktokLimit"
                                            placeholder="-"
                                            class="w-12 bg-transparent border-b border-gray-600 focus:border-blue-500 text-center text-sm"
                                            title="TikTok –ª–∏–º–∏—Ç (–ø—É—Å—Ç–æ = –≥–ª–æ–±–∞–ª—å–Ω—ã–π)">
                                    </td>
                                    <td class="p-4 text-center">
                                        <input type="number" min="0" max="50" v-model.number="profile.youtubeLimit"
                                            placeholder="-"
                                            class="w-12 bg-transparent border-b border-gray-600 focus:border-blue-500 text-center text-sm"
                                            title="YouTube –ª–∏–º–∏—Ç (–ø—É—Å—Ç–æ = –≥–ª–æ–±–∞–ª—å–Ω—ã–π)">
                                    </td>
                                    <td class="p-4 text-center">
                                        <label class="inline-flex items-center cursor-pointer">
                                            <input type="checkbox" :checked="profile.enabled !== false"
                                                @change="profile.enabled = !profile.enabled; saveConfig()"
                                                class="sr-only peer">
                                            <div class="relative w-11 h-6 rounded-full peer
                                                bg-gray-700 peer-checked:after:translate-x-full
                                                peer-checked:after:border-white after:content-['']
                                                after:absolute after:top-[2px] after:start-[2px]
                                                after:bg-white after:border-gray-300 after:border
                                                after:rounded-full after:h-5 after:w-5 after:transition-all
                                                peer-checked:bg-green-600"></div>
                                        </label>
                                    </td>
                                </tr>
                            </template>
                            <tr v-if="config.profiles.length === 0">
                                <td colspan="9" class="p-8 text-center" style="color: var(--text-secondary)">
                                    –ù–µ—Ç –ø—Ä–æ—Ñ–∏–ª–µ–π. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Sync –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ UploadPost.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="mt-6 text-sm" style="color: var(--text-secondary)">
                    –í—Å–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª–µ–π: {{ config.profiles.length }} |
                    –ê–∫—Ç–∏–≤–Ω—ã—Ö: {{ config.profiles.filter(p => p.enabled !== false).length }}
                </div>
            </div>


            <!-- SETTINGS PAGE -->
            <div v-if="currentTab === 'settings'">
                <h1 class="text-3xl font-bold mb-6">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>

                <!-- Scheduler Settings -->
                <div class="glass-card p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4">‚è∞ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ</h2>

                    <div class="space-y-4">
                        <div class="flex items-center gap-3">
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="checkbox" v-model="schedule.enabled" class="sr-only peer">
                                <div class="relative w-14 h-7 rounded-full peer 
                                    peer-focus:ring-4 peer-focus:ring-blue-800
                                    bg-gray-700 peer-checked:after:translate-x-full 
                                    peer-checked:after:border-white after:content-[''] 
                                    after:absolute after:top-0.5 after:start-[4px] 
                                    after:bg-white after:border-gray-300 after:border 
                                    after:rounded-full after:h-6 after:w-6 after:transition-all
                                    peer-checked:bg-blue-600"></div>
                            </label>
                            <span class="text-lg font-medium">{{ schedule.enabled ? '–í–∫–ª—é—á–µ–Ω–æ' : '–í—ã–∫–ª—é—á–µ–Ω–æ' }}</span>
                        </div>

                        <div>
                            <label class="block text-sm mb-2" style="color: var(--text-secondary)">
                                –í—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞ ({{ schedule.timezone }})
                            </label>
                            <input type="time" v-model="schedule.dailyRunTime" class="p-3 rounded-lg border-0 text-lg"
                                style="background: rgba(255, 255, 255, 0.05); color: var(--text-primary)">
                        </div>

                        <button @click="saveSchedule" class="btn-primary">
                            üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
                        </button>
                    </div>
                </div>

                <!-- Platform Limits -->
                <div class="glass-card p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4">üìä –õ–∏–º–∏—Ç—ã –ø–ª–∞—Ç—Ñ–æ—Ä–º (–∑–∞ –¥–µ–Ω—å)</h2>

                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm mb-2" style="color: var(--text-secondary)">Instagram</label>
                            <input type="number" v-model.number="config.limits.instagram" min="0"
                                class="w-full p-3 rounded-lg border-0"
                                style="background: rgba(255, 255, 255, 0.05); color: var(--text-primary)">
                        </div>
                        <div>
                            <label class="block text-sm mb-2" style="color: var(--text-secondary)">TikTok</label>
                            <input type="number" v-model.number="config.limits.tiktok" min="0"
                                class="w-full p-3 rounded-lg border-0"
                                style="background: rgba(255, 255, 255, 0.05); color: var(--text-primary)">
                        </div>
                        <div>
                            <label class="block text-sm mb-2" style="color: var(--text-secondary)">YouTube</label>
                            <input type="number" v-model.number="config.limits.youtube" min="0"
                                class="w-full p-3 rounded-lg border-0"
                                style="background: rgba(255, 255, 255, 0.05); color: var(--text-primary)">
                        </div>
                    </div>
                </div>

                <!-- Days to Generate -->
                <div class="glass-card p-6">
                    <h2 class="text-xl font-semibold mb-4">üìÖ –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>

                    <div>
                        <label class="block text-sm mb-2" style="color: var(--text-secondary)">
                            –ù–∞ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –≤–ø–µ—Ä—ë–¥ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å?
                        </label>
                        <input type="number" v-model.number="config.daysToGenerate" min="1" max="30" autocomplete="off"
                            class="w-full p-3 rounded-lg border-0"
                            style="background: rgba(255, 255, 255, 0.05); color: var(--text-primary)" placeholder="1">
                        <p class="text-xs mt-2" style="color: var(--text-secondary)">
                            1 = —Ç–æ–ª—å–∫–æ —Å–µ–≥–æ–¥–Ω—è. 7 = –Ω–µ–¥–µ–ª—è –≤–ø–µ—Ä—ë–¥.
                        </p>
                    </div>
                </div>
            </div>

            <!-- PROFILES PAGE (simplified for now) -->


            <div v-if="currentTab === 'clients'">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold">AI –ö–ª–∏–µ–Ω—Ç—ã –∏ –ü—Ä–æ–º—Ç—ã</h1>
                    <button @click="addClient" aria-label="–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞" class="btn-primary">
                        + –î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞
                    </button>
                </div>

                <div v-for="(client, idx) in config.clients" :key="idx" class="glass-card p-6 mb-4">
                    <div class="grid grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-sm mb-2" style="color: var(--text-secondary)">–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞
                                (–±—Ä–µ–Ω–¥)</label>
                            <input v-model="client.name" class="w-full p-3 rounded-lg border-0"
                                style="background: rgba(255, 255, 255, 0.05); color: var(--text-primary)">
                        </div>
                        <div>
                            <label class="block text-sm mb-2" style="color: var(--text-secondary)">Regex –ø–∞–ø–∫–∏</label>
                            <input v-model="client.regex" class="w-full p-3 rounded-lg border-0 font-mono text-sm"
                                style="background: rgba(255, 255, 255, 0.05); color: var(--text-primary)">
                        </div>
                        <div>
                            <label class="block text-sm mb-2" style="color: var(--text-secondary)">–ö–≤–æ—Ç–∞
                                (–≤–∏–¥–µ–æ/–º–µ—Å—è—Ü)</label>
                            <input v-model.number="client.quota" type="number" min="0"
                                class="w-full p-3 rounded-lg border-0"
                                style="background: rgba(255, 255, 255, 0.05); color: var(--text-primary)"
                                placeholder="30">
                            <div v-if="client.quota" class="mt-3">
                                <div class="text-sm mb-2" style="color: var(--text-secondary)">
                                    <span class="font-semibold" style="color: var(--text-primary)">{{
                                        getClientPublished(client) }}</span> / {{ client.quota }}
                                    –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ
                                    <span class="ml-2" style="color: var(--success)">(–æ—Å—Ç–∞–ª–æ—Å—å: {{
                                        getClientRemaining(client) }})</span>
                                </div>
                                <div class="w-full rounded-full h-2 overflow-hidden"
                                    style="background: rgba(255, 255, 255, 0.1)">
                                    <div class="h-full transition-all"
                                        :style="{ width: getClientProgress(client) + '%', background: 'var(--accent-primary)' }">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm mb-2" style="color: var(--text-secondary)">AI –°–∏—Å—Ç–µ–º–Ω—ã–π
                            –ø—Ä–æ–º—Ç</label>
                        <textarea v-model="client.prompt" rows="4"
                            class="w-full p-3 rounded-lg border-0 font-mono text-sm"
                            style="background: rgba(255, 255, 255, 0.05); color: var(--text-primary)"></textarea>
                    </div>
                    <div class="text-right">
                        <button @click="removeClient(idx)" class="text-sm hover:underline" style="color: var(--error)">
                            –£–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞
                        </button>
                    </div>
                </div>

                <div v-if="config.clients.length === 0" class="glass-card p-8 text-center">
                    <p style="color: var(--text-secondary)">–ù–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞.</p>
                </div>
            </div>

            <div v-if="currentTab === 'logs'">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold">üìã –õ–æ–≥–∏ —Å–∏—Å—Ç–µ–º—ã</h1>
                    <div class="flex gap-3 items-center">
                        <label class="flex items-center gap-2 text-sm">
                            <input type="checkbox" v-model="logsAutoRefresh" class="rounded">
                            <span>–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (3 —Å–µ–∫)</span>
                        </label>
                        <button @click="loadLogs" aria-label="–û–±–Ω–æ–≤–∏—Ç—å –ª–æ–≥–∏ —Å–∏—Å—Ç–µ–º—ã" class="btn-secondary">
                            üîÑ –û–±–Ω–æ–≤–∏—Ç—å
                        </button>
                    </div>
                </div>

                <div v-if="logsLoading" class="glass-card p-8 text-center">
                    <span style="color: var(--text-secondary)">–ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤...</span>
                </div>

                <div v-else class="glass-card p-4 overflow-auto font-mono text-xs"
                    style="max-height: 600px; background: #000; color: #00ff00;">
                    <div v-for="(line, idx) in logs" :key="idx" class="hover:bg-gray-900 px-2 py-1">
                        {{ line }}
                    </div>
                    <div v-if="logs.length === 0" class="p-8 text-center" style="color: #666">
                        –õ–æ–≥–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    currentTab: 'dashboard',
                    tabs: [
                        { id: 'dashboard', name: '–î–∞—à–±–æ—Ä–¥' },
                        { id: 'stats', name: '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞' },
                        { id: 'profiles', name: '–ü—Ä–æ—Ñ–∏–ª–∏' },
                        { id: 'settings', name: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏' },
                        { id: 'clients', name: 'AI –ö–ª–∏–µ–Ω—Ç—ã' },
                        { id: 'logs', name: 'üìã –õ–æ–≥–∏' }
                    ],
                    config: {
                        cronSchedule: '',
                        daysToGenerate: 1,
                        yandexFolders: [],
                        limits: { instagram: 0, tiktok: 0, youtube: 0 },
                        profiles: [],
                        clients: [],
                        themeAliases: {}
                    },
                    stats: {
                        totalVideos: 0,
                        publishedCount: 0,
                        byCategory: {},
                        byAuthor: {},
                        byBrand: {},
                        profilesByCategory: {},
                        profilesByAuthor: {},
                        profilesByBrand: {}
                    },
                    brandStats: {},
                    currentMonth: new Date().toISOString().substring(0, 7),
                    statsViewMode: 'category',
                    loading: true,
                    logs: [],
                    logsLoading: false,
                    logsAutoRefresh: false,
                    schedule: {
                        enabled: false,
                        timezone: 'Europe/Moscow',
                        dailyRunTime: '00:01'
                    },
                    todayStats: {
                        date: '--',
                        time_msk: '--:--',
                        success_count: 0
                    },
                    selectedProfiles: [],
                    bulkThemeKey: '',
                    publishingStats: null,
                    errorStats: [],
                    expandedGroups: {} // Format: { 'GroupName': true/false }
                };
            },
            async mounted() {
                await this.loadConfig();
                this.loadSchedule();
                this.loadStats();
                this.loadBrandStats();
                this.loadPublishingStats();
                this.loadErrors();
                setInterval(() => this.loadStats(), 60000);
            },
            computed: {
                groupedProfiles() {
                    if (!this.config.profiles) return [];
                    const groups = {};

                    // Sort profiles by username first for consistent internal order
                    const sortedProfiles = [...this.config.profiles].sort((a, b) =>
                        (a.username || '').localeCompare(b.username || '')
                    );

                    sortedProfiles.forEach(p => {
                        const rawKey = p.theme_key ? p.theme_key.trim() : '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–π';
                        // Capitalize logic if desired, or keep raw
                        const key = rawKey || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–π';

                        if (!groups[key]) groups[key] = [];
                        groups[key].push(p);
                    });

                    // Return as array of objects for consistent sorting
                    return Object.keys(groups).sort().map(key => ({
                        name: key,
                        profiles: groups[key]
                    }));
                },
                currentStatsList() {
                    let source = {};
                    if (this.statsViewMode === 'author') source = this.stats.byAuthor || {};
                    else if (this.statsViewMode === 'brand') source = this.stats.byBrand || {};
                    else source = this.stats.byCategory || {};

                    return Object.entries(source)
                        .map(([name, count]) => ({ name, count }))
                        .filter(item => item.name !== 'unknown')
                        .sort((a, b) => a.name.localeCompare(b.name));
                },
                statsHeader() {
                    if (this.statsViewMode === 'category') return '–ö–∞—Ç–µ–≥–æ—Ä–∏—è';
                    if (this.statsViewMode === 'brand') return '–ë—Ä–µ–Ω–¥';
                    return '–ê–≤—Ç–æ—Ä';
                },
                availableThemes() {
                    const fromStats = Object.keys(this.stats.byCategory || {});
                    const fromAliases = Object.keys(this.config.themeAliases || {});
                    // Extract themes from existing profiles too
                    const fromProfiles = this.config.profiles.map(p => p.theme_key).filter(Boolean);

                    const all = new Set([...fromStats, ...fromAliases, ...fromProfiles]);
                    return Array.from(all).sort().filter(t => t !== 'unknown');
                }
            },
            methods: {
                getProfilesForCategory(categoryName) {
                    const key = categoryName.toLowerCase().trim();
                    if (this.statsViewMode === 'author') {
                        return this.stats.profilesByAuthor?.[key] || [];
                    } else if (this.statsViewMode === 'brand') {
                        return this.stats.profilesByBrand?.[key] || [];
                    } else {
                        return this.stats.profilesByCategory?.[key] || [];
                    }
                },
                getPublishedCount(name) {
                    const cleanName = name.toLowerCase().replace(" ", "");
                    let total = 0;
                    Object.entries(this.brandStats).forEach(([key, val]) => {
                        const [cat, br] = key.split(':');
                        if (this.statsViewMode === 'brand') {
                            if (br === cleanName) total += val.published_count || 0;
                        } else if (this.statsViewMode === 'category') {
                            if (cat === cleanName) total += val.published_count || 0;
                        }
                    });
                    return total > 0 ? total : '-';
                },
                async loadConfig() {
                    this.loading = true;
                    try {
                        const res = await fetch('/api/config');
                        if (!res.ok) throw new Error(`Server returned ${res.status}`);
                        const data = await res.json();
                        this.config = {
                            profiles: [],
                            clients: [],
                            limits: { instagram: 10, tiktok: 10, youtube: 2 },
                            yandexFolders: [],
                            themeAliases: {},
                            ...data
                        };
                        if (!this.config.profiles) this.config.profiles = [];
                        if (!this.config.clients) this.config.clients = [];
                        if (!this.config.limits) this.config.limits = { instagram: 10, tiktok: 10, youtube: 2 };
                    } catch (e) {
                        console.error('[UI] Failed to load config:', e);
                    } finally {
                        this.loading = false;
                    }
                },
                async saveConfig() {
                    try {
                        await fetch('/api/config', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.config)
                        });
                        alert('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!');
                    } catch (e) {
                        alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                    }
                },
                async loadStats(force = false) {
                    try {
                        const url = force ? '/api/stats?refresh=true' : '/api/stats';
                        const res = await fetch(url);
                        if (res.ok) {
                            this.stats = await res.json();
                        }
                    } catch (e) {
                        console.error('Failed to load stats', e);
                    }
                },
                async loadSchedule() {
                    try {
                        const res = await fetch('/api/schedule');
                        if (res.ok) {
                            const data = await res.json();
                            this.schedule = {
                                enabled: data.enabled || false,
                                timezone: data.timezone || 'Europe/Moscow',
                                dailyRunTime: data.dailyRunTime || '00:01'
                            };
                        }
                    } catch (e) {
                        console.error('[UI] Failed to load schedule:', e);
                    }
                },
                async saveSchedule() {
                    try {
                        const res = await fetch('/api/schedule', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.schedule)
                        });
                        if (res.ok) {
                            alert('‚úÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!');
                            await this.loadConfig();
                        } else {
                            const error = await res.json();
                            alert(`‚ùå –û—à–∏–±–∫–∞: ${error.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å'}`);
                        }
                    } catch (e) {
                        alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è');
                    }
                },
                async loadBrandStats() {
                    try {
                        const res = await fetch(`/api/brands/stats?month=${this.currentMonth}`);
                        if (res.ok) {
                            const data = await res.json();
                            this.brandStats = data.stats || {};
                        }
                    } catch (e) {
                        console.error('[UI] Failed to load brand stats:', e);
                    }
                },
                async triggerRun(testMode = false) {
                    await this.saveConfig();
                    if (!confirm(testMode ? '–ó–∞–ø—É—Å—Ç–∏—Ç—å –≤ –¢–ï–°–¢–û–í–û–ú —Ä–µ–∂–∏–º–µ (–ø–æ 1 –ø–æ—Å—Ç—É –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É)?' : '–ó–∞–ø—É—Å—Ç–∏—Ç—å –ü–û–õ–ù–´–ô —Ü–∏–∫–ª –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏?')) return;
                    try {
                        await fetch('/api/run', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ testMode })
                        });
                        alert('‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –∑–∞–ø—É—â–µ–Ω–∞ –≤ —Ñ–æ–Ω–µ');
                    } catch (e) {
                        alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å');
                    }
                },
                async triggerCleanup() {
                    if (!confirm('üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç—ã?')) return;
                    try {
                        const res = await fetch('/api/cleanup', { method: 'POST' });
                        const data = await res.json();
                        alert(data.message || '‚úÖ –û—á–∏—â–µ–Ω–æ!');
                    } catch (e) {
                        alert('‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏');
                    }
                },
                async loadLogs() {
                    this.logsLoading = true;
                    try {
                        const res = await fetch('/api/logs?lines=200');
                        const data = await res.json();
                        this.logs = data.logs || [];
                    } catch (e) {
                        console.error('Failed to load logs:', e);
                    } finally {
                        this.logsLoading = false;
                    }
                },
                async loadPublishingStats() {
                    try {
                        const res = await fetch('/api/stats/publishing');
                        if (res.ok) {
                            this.publishingStats = await res.json();
                        }
                    } catch (e) {
                        console.error('Failed to load publishing stats:', e);
                    }
                },
                async loadErrors() {
                    try {
                        const res = await fetch('/api/stats/errors');
                        if (res.ok) {
                            const data = await res.json();
                            if (data.grouped_errors) {
                                this.errorStats = data.grouped_errors;
                            }
                        }
                    } catch (e) {
                        console.error('Failed to load errors:', e);
                    }
                },
                addClient() {
                    this.config.clients.push({ name: 'New Client', regex: '', prompt: '', quota: 0 });
                },
                removeClient(idx) {
                    this.config.clients.splice(idx, 1);
                },
                getClientPublished(client) {
                    if (!client.name || !client.regex) return 0;
                    const categoryMatch = client.regex.match(/([a-zA-Z–∞-—è–ê-–Ø0-9]+)/);
                    const category = categoryMatch ? categoryMatch[1].toLowerCase() : 'unknown';
                    const brandName = client.name.toLowerCase().replace(/[^a-z–∞-—è0-9]/g, '');
                    const key = `${category}:${brandName}`;
                    return this.brandStats[key]?.published_count || 0;
                },
                getClientRemaining(client) {
                    const quota = client.quota || 0;
                    const published = this.getClientPublished(client);
                    return Math.max(0, quota - published);
                },
                getClientProgress(client) {
                    const quota = client.quota || 0;
                    if (quota === 0) return 0;
                    const published = this.getClientPublished(client);
                    return Math.min(100, Math.round((published / quota) * 100));
                },
                // --- PROFILE SELECTION & BULK ACTIONS ---
                toggleSelection(username) {
                    const idx = this.selectedProfiles.indexOf(username);
                    if (idx === -1) this.selectedProfiles.push(username);
                    else this.selectedProfiles.splice(idx, 1);
                },
                selectAll(checked) {
                    if (checked) {
                        this.selectedProfiles = this.config.profiles.map(p => p.username);
                    } else {
                        this.selectedProfiles = [];
                    }
                },
                async applyBulkCategory() {
                    if (!this.bulkThemeKey) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é!');
                    let count = 0;
                    this.config.profiles.forEach(p => {
                        if (this.selectedProfiles.includes(p.username)) {
                            p.theme_key = this.bulkThemeKey;
                            count++;
                        }
                    });
                    await this.saveConfig();
                    alert(`‚úÖ –ö–∞—Ç–µ–≥–æ—Ä–∏—è "${this.bulkThemeKey}" –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –∫ ${count} –ø—Ä–æ—Ñ–∏–ª—è–º`);
                    this.selectedProfiles = [];
                    this.bulkThemeKey = '';
                },
                async toggleBulkEnabled(state) {
                    let count = 0;
                    this.config.profiles.forEach(p => {
                        if (this.selectedProfiles.includes(p.username)) {
                            p.enabled = state;
                            count++;
                        }
                    });
                    await this.saveConfig();
                    alert(`‚úÖ ${count} –ø—Ä–æ—Ñ–∏–ª–µ–π ${state ? '–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã' : '–æ—Ç–∫–ª—é—á–µ–Ω—ã'}`);
                    this.selectedProfiles = [];
                },
                toggleGroup(groupName) {
                    // Initialize if undefined (default should be true/expanded, but we check inverse)
                    if (this.expandedGroups[groupName] === undefined) {
                        this.expandedGroups[groupName] = false; // Toggle to closed if it was implicitly open? 
                        // Actually let's assume default is CLOSED to save space, user clicks to OPEN?
                        // Or default OPEN? Most users want to see everything.
                        // Let's implement: if undefined -> set to false (collapsed). User explicitly opens.
                        // User request: "they all go in a long list", implying they want organization.
                        // Let's default to OPEN (true) in logic, so toggle sets to false.
                        this.expandedGroups[groupName] = false;
                    } else {
                        this.expandedGroups[groupName] = !this.expandedGroups[groupName];
                    }
                },
                isGroupExpanded(groupName) {
                    // Default to TRUE (Expanded) if undefined
                    return this.expandedGroups[groupName] !== false;
                },
                toggleGroupSelection(groupProfiles, checked) {
                    groupProfiles.forEach(p => {
                        const idx = this.selectedProfiles.indexOf(p.username);
                        if (checked) {
                            if (idx === -1) this.selectedProfiles.push(p.username);
                        } else {
                            if (idx !== -1) this.selectedProfiles.splice(idx, 1);
                        }
                    });
                },
                isGroupSelected(groupProfiles) {
                    if (groupProfiles.length === 0) return false;
                    return groupProfiles.every(p => this.selectedProfiles.includes(p.username));
                }
            }
        }).mount('#app');
    </script>>
</body>

</html>