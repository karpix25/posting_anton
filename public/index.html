<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (v1.1)</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Hide number input arrows */
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      appearance: none;
      margin: 0;
    }

    input[type=number] {
      -moz-appearance: textfield;
      appearance: textfield;
    }

    /* Accessibility: Reduce motion for users who prefer it */
    @media (prefers-reduced-motion: reduce) {

      *,
      *::before,
      *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* Improved focus states */
    button:focus-visible,
    input:focus-visible,
    select:focus-visible,
    textarea:focus-visible {
      outline: 2px solid #3b82f6;
      outline-offset: 2px;
    }
  </style>
</head>

<body class="bg-gray-100 text-gray-800">
  <div id="app" class="min-h-screen p-8">

    <!-- Header -->
    <div class="max-w-6xl mx-auto mb-8 flex justify-between items-center">
      <h1 class="text-3xl font-bold text-blue-600">üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –ö–æ–Ω—Ç–µ–Ω—Ç–∞</h1>
      <div class="flex items-center gap-4">
        <!-- Real-time Status Indicator -->
        <div class="flex items-center gap-2 px-3 py-1 rounded-full text-sm font-semibold transition-colors"
          :class="realtime.connected ? 'bg-green-100 text-green-700 border border-green-200' : 'bg-amber-100 text-amber-700 border border-amber-200'">
          <span class="relative flex h-3 w-3">
            <span v-if="realtime.connected"
              class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
            <span class="relative inline-flex rounded-full h-3 w-3"
              :class="realtime.connected ? 'bg-green-500' : 'bg-amber-500'"></span>
          </span>
          {{ realtime.connected ? 'Online' : 'Connecting...' }}
        </div>

        <button @click="saveConfig" aria-label="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"
          class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded shadow focus-visible:ring-2 focus-visible:ring-green-300">
          –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
        </button>
      </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-6xl mx-auto bg-white rounded-lg shadow-lg overflow-hidden flex">

      <!-- Sidebar / Tabs -->
      <div class="w-64 bg-gray-50 border-r p-4 space-y-2">
        <button v-for="tab in tabs" :key="tab.id" @click="currentTab = tab.id"
          :class="['w-full text-left px-4 py-2 rounded', currentTab === tab.id ? 'bg-blue-100 text-blue-700 font-semibold' : 'hover:bg-gray-200']">
          {{ tab.name }}
        </button>
      </div>

      <!-- Tab Content -->
      <div class="flex-1 p-8">
        <div v-if="loading" class="text-center text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫...</div>

        <div v-else>

          <!-- DASHBOARD TAB -->
          <div v-if="currentTab === 'dashboard'">
            <h2 class="text-2xl font-bold mb-4">–°—Ç–∞—Ç—É—Å</h2>
            <div class="grid grid-cols-3 gap-4 mb-8">
              <div class="bg-blue-50 p-4 rounded border border-blue-100">
                <div class="text-sm text-gray-500">–°–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—É—Å–∫</div>
                <div class="text-lg font-mono">{{ formatCron(config.cronSchedule) }}</div>
              </div>
              <div class="bg-purple-50 p-4 rounded border border-purple-100">
                <div class="text-sm text-gray-500">–ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏</div>
                <div class="text-lg font-bold">{{ config.profiles?.length || 0 }}</div>
              </div>
              <div class="bg-indigo-50 p-4 rounded border border-indigo-100 flex flex-col justify-between">
                <div>
                  <div class="text-sm text-gray-500">–í–∏–¥–µ–æ –Ω–∞ –¥–∏—Å–∫–µ</div>
                  <div class="text-lg font-bold" v-if="stats">{{ stats.totalVideos }}</div>
                  <div class="text-lg font-bold text-gray-400" v-else>--</div>
                </div>
                <button @click="loadStats" aria-label="–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤–∏–¥–µ–æ"
                  class="mt-2 text-xs bg-indigo-200 hover:bg-indigo-300 px-2 py-1 rounded text-indigo-800 self-start focus-visible:ring-2 focus-visible:ring-indigo-500">
                  üîÑ Sync
                </button>
              </div>
            </div>

            <!-- Today Stats Cards -->
            <div class="flex gap-4 flex-wrap">
              <!-- Date Card -->
              <div
                class="bg-gradient-to-br from-slate-50 to-slate-100 border border-slate-200 p-4 rounded-lg shadow-sm min-w-[140px]">
                <div class="text-sm text-slate-500 mb-1">üìÖ –î–∞—Ç–∞ (–ú–°–ö)</div>
                <div class="text-xl font-bold text-slate-700">{{ todayStats.date || '--' }}</div>
                <div class="text-xs text-slate-400 mt-1">{{ todayStats.time_msk || '--:--' }}</div>
              </div>

              <!-- Success Posts -->
              <div
                class="bg-gradient-to-br from-green-50 to-emerald-100 border border-green-200 p-4 rounded-lg shadow-sm min-w-[140px]">
                <div class="text-sm text-green-600 mb-1">‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ</div>
                <div class="text-2xl font-bold text-green-700">{{ todayStats.success_count || 0 }}</div>
                <div class="text-xs text-green-500 mt-1">–∑–∞ —Å–µ–≥–æ–¥–Ω—è</div>
              </div>

              <!-- Active Profiles -->
              <div
                class="bg-gradient-to-br from-blue-50 to-indigo-100 border border-blue-200 p-4 rounded-lg shadow-sm min-w-[140px]">
                <div class="text-sm text-blue-600 mb-1">üë§ –ü—Ä–æ—Ñ–∏–ª–µ–π</div>
                <div class="text-2xl font-bold text-blue-700">{{ todayStats.profiles_count || 0 }}</div>
                <div class="text-xs text-blue-500 mt-1">–∞–∫—Ç–∏–≤–Ω—ã—Ö</div>
              </div>

              <!-- Queued Posts -->
              <div
                class="bg-gradient-to-br from-amber-50 to-orange-100 border border-amber-200 p-4 rounded-lg shadow-sm min-w-[140px]">
                <div class="text-sm text-amber-600 mb-1">‚è≥ –í –æ—á–µ—Ä–µ–¥–∏</div>
                <div class="text-2xl font-bold text-amber-700">{{ todayStats.queued_count || 0 }}</div>
                <div class="text-xs text-amber-500 mt-1">–æ–∂–∏–¥–∞—é—Ç</div>
              </div>

              <!-- Failed Posts -->
              <div v-if="todayStats.failed_count > 0"
                class="bg-gradient-to-br from-red-50 to-rose-100 border border-red-200 p-4 rounded-lg shadow-sm min-w-[140px]">
                <div class="text-sm text-red-600 mb-1">‚ùå –û—à–∏–±–∫–∏</div>
                <div class="text-2xl font-bold text-red-700">{{ todayStats.failed_count }}</div>
                <div class="text-xs text-red-500 mt-1">–∑–∞ —Å–µ–≥–æ–¥–Ω—è</div>
              </div>
            </div>

            <button @click="triggerRun(false)"
              class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded text-lg font-semibold">
              –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—é
            </button>
            <button @click="triggerRun(true)"
              class="bg-amber-500 hover:bg-amber-600 text-white px-6 py-3 rounded text-lg font-semibold"
              title="Only 1 post per platform (Safe Mode)">
              üß™ –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ (1 –ø–æ—Å—Ç)
            </button>
            <button @click="triggerCleanup"
              class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded text-lg font-semibold"
              title="–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç—ã">
              üóëÔ∏è –°–±—Ä–æ—Å
            </button>

            <!-- GROUPED ERRORS -->
            <div v-if="groupedErrors.length > 0" class="mt-8 col-span-full w-full">
              <h3 class="text-xl font-bold mb-4 text-red-600 flex items-center gap-2">
                <span>‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —Å–µ–≥–æ–¥–Ω—è</span>
                <span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full">{{ groupedErrors.length }}</span>
              </h3>

              <div class="space-y-4">
                <div v-for="(group, idx) in groupedErrors" :key="idx"
                  class="bg-red-50 border border-red-200 rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow">
                  <div class="flex flex-col sm:flex-row justify-between items-start gap-2">
                    <div>
                      <div class="font-bold text-lg text-gray-800 flex items-center gap-2">
                        <span>@{{ group.profile }}</span>
                        <span class="text-gray-500 font-normal text-sm">({{ group.video }})</span>
                      </div>
                      <div class="text-xs text-gray-400 mt-0.5">
                        üïí {{ new Date(group.timestamp).toLocaleTimeString() }}
                      </div>
                    </div>

                    <div class="flex gap-2">
                      <span v-for="platform in group.platforms" :key="platform"
                        class="px-2 py-1 text-xs rounded font-bold uppercase tracking-wider" :class="{
                                 'bg-pink-100 text-pink-700': platform === 'instagram',
                                 'bg-blue-100 text-blue-700': platform === 'tiktok',
                                 'bg-red-100 text-red-700': platform === 'youtube'
                               }">
                        {{ platform }}
                      </span>
                    </div>
                  </div>

                  <div class="mt-3 bg-white rounded p-3 border border-red-100">
                    <div v-for="(msg, mIdx) in group.messages" :key="mIdx"
                      class="text-sm text-red-700 font-medium flex items-start gap-2">
                      <span>‚Ä¢</span>
                      <span>{{ msg }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- STATS TAB -->
        <div v-if="currentTab === 'stats'">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
            <button @click="loadStats(true)" aria-label="–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"
              class="text-sm bg-gray-200 px-3 py-1 rounded hover:bg-gray-300 focus-visible:ring-2 focus-visible:ring-blue-500">üîÑ
              –û–±–Ω–æ–≤–∏—Ç—å</button>
          </div>

          <div v-if="statsLoading" class="text-center py-8 text-gray-500">–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫–∞...</div>
          <div v-else>
            <!-- Overview Cards -->
            <div class="grid grid-cols-2 gap-6 mb-8">
              <div class="bg-blue-50 p-6 rounded-lg border border-blue-100 text-center">
                <div class="text-gray-500 mb-1">–í—Å–µ–≥–æ –¥–æ—Å—Ç—É–ø–Ω–æ –≤–∏–¥–µ–æ</div>
                <div class="text-4xl font-bold text-blue-700">{{ stats.totalVideos }}</div>
                <div class="text-xs text-blue-400 mt-2">–ì–æ—Ç–æ–≤—ã –∫ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ (Yandex Disk)</div>
              </div>
              <div class="bg-green-50 p-6 rounded-lg border border-green-100 text-center">
                <div class="text-gray-500 mb-1">–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ –∏ —É–¥–∞–ª–µ–Ω–æ</div>
                <div class="text-4xl font-bold text-green-700">{{ stats.publishedCount }}</div>
                <div class="text-xs text-green-400 mt-2">–ó–∞ –≤—Å—ë –≤—Ä–µ–º—è</div>
              </div>
            </div>

            <!-- Statistics Summary Cards -->
            <div v-if="statsSummary" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
              <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg p-6 text-white shadow-lg">
                <div class="text-sm opacity-90">–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ</div>
                <div class="text-3xl font-bold mt-2">{{ statsSummary.published_total }}</div>
              </div>
              <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-lg p-6 text-white shadow-lg">
                <div class="text-sm opacity-90">–£–¥–∞–ª–µ–Ω–æ</div>
                <div class="text-3xl font-bold mt-2">{{ statsSummary.deleted_total }}</div>
              </div>
              <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg p-6 text-white shadow-lg">
                <div class="text-sm opacity-90">Instagram</div>
                <div class="text-3xl font-bold mt-2">{{ statsSummary.by_platform.instagram }}</div>
              </div>
              <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg p-6 text-white shadow-lg">
                <div class="text-sm opacity-90">TikTok + YouTube</div>
                <div class="text-3xl font-bold mt-2">{{ statsSummary.by_platform.tiktok +
                  statsSummary.by_platform.youtube }}</div>
              </div>
            </div>

            <!-- Categories Breakdown -->
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-xl font-bold">–†–∞–∑–±–∏–≤–∫–∞ –ø–æ {{ statsViewMode === 'category' ? '–ö–∞—Ç–µ–≥–æ—Ä–∏—è–º' : (statsViewMode
                === 'brand' ? '–ë—Ä–µ–Ω–¥–∞–º' : '–ê–≤—Ç–æ—Ä–∞–º') }}
              </h3>

              <div class="bg-gray-200 p-1 rounded-lg flex text-sm">
                <button @click="statsViewMode = 'category'"
                  :class="['px-3 py-1 rounded-md transition', statsViewMode === 'category' ? 'bg-white shadow text-blue-600 font-bold' : 'text-gray-600 hover:text-gray-800']">
                  –ü–æ –¢–µ–º–∞–º
                </button>
                <button @click="statsViewMode = 'author'"
                  :class="['px-3 py-1 rounded-md transition', statsViewMode === 'author' ? 'bg-white shadow text-blue-600 font-bold' : 'text-gray-600 hover:text-gray-800']">
                  –ü–æ –ê–≤—Ç–æ—Ä–∞–º
                </button>
                <button @click="statsViewMode = 'brand'"
                  :class="['px-3 py-1 rounded-md transition', statsViewMode === 'brand' ? 'bg-white shadow text-blue-600 font-bold' : 'text-gray-600 hover:text-gray-800']">
                  –ü–æ –ë—Ä–µ–Ω–¥–∞–º
                </button>
              </div>
            </div>
            <div class="bg-white border rounded-lg overflow-hidden">
              <table class="w-full border-collapse mt-6">
                <thead class="bg-gray-100">
                  <tr>
                    <th class="text-left p-3 border-b">{{ statsHeader }}</th>
                    <th class="text-left p-3 border-b">–ü—Ä–æ—Ñ–∏–ª–∏</th>
                    <th class="text-right p-3 border-b w-32">–ù–∞ –î–∏—Å–∫–µ</th>
                    <th class="text-right p-3 border-b w-32">–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="item in currentStatsList" :key="item.name" class="border-b hover:bg-gray-50">
                    <td class="p-3 capitalize">{{ item.name }}</td>
                    <td class="p-3">
                      <div class="flex gap-2 flex-wrap">
                        <span v-for="profile in getProfilesForCategory(item.name)" :key="profile"
                          class="px-2 py-1 text-xs bg-blue-50 text-blue-700 rounded">
                          {{ profile }}
                        </span>
                        <span
                          v-if="!getProfilesForCategory(item.name) || getProfilesForCategory(item.name).length === 0"
                          class="text-gray-400 text-sm italic">
                          –ù–µ—Ç –ø—Ä–æ—Ñ–∏–ª–µ–π
                        </span>
                      </div>
                    </td>
                    <td class="p-3 text-right font-semibold">{{ item.count.toLocaleString() }}</td>
                    <td class="p-3 text-right font-bold text-green-600">{{ getPublishedCount(item.name) }}</td>
                  </tr>
                  <tr v-if="currentStatsList.length === 0">
                    <td colspan="3" class="p-4 text-center text-gray-400">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- SETTINGS TAB -->
        <div v-if="currentTab === 'settings'">
          <h2 class="text-2xl font-bold mb-4">–û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h2>

          <!-- Schedule Settings -->
          <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded">
            <h3 class="text-lg font-bold mb-3">‚è∞ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏</h3>

            <div class="mb-4">
              <label class="flex items-center cursor-pointer">
                <input type="checkbox" v-model="schedule.enabled" class="mr-2 w-5 h-5">
                <span class="font-semibold">–í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫</span>
              </label>
              <p class="text-xs text-gray-600 mt-1 ml-7">–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –±—É–¥–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
              </p>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block mb-2 font-semibold">–í—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞</label>
                <input type="time" v-model="schedule.dailyRunTime" class="w-full border p-2 rounded"
                  :disabled="!schedule.enabled">
                <p class="text-xs text-gray-500 mt-1">–§–æ—Ä–º–∞—Ç: HH:MM (24-—á–∞—Å–æ–≤–æ–π)</p>
              </div>

              <div>
                <label class="block mb-2 font-semibold">–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å</label>
                <select v-model="schedule.timezone" class="w-full border p-2 rounded" :disabled="!schedule.enabled">
                  <option value="Europe/Moscow">–ú–æ—Å–∫–≤–∞ (–ú–°–ö, UTC+3)</option>
                  <option value="Europe/Kiev">–ö–∏–µ–≤ (UTC+2)</option>
                  <option value="Asia/Yekaterinburg">–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥ (UTC+5)</option>
                  <option value="Asia/Novosibirsk">–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫ (UTC+7)</option>
                  <option value="UTC">UTC (UTC+0)</option>
                </select>
              </div>
            </div>

            <div class="mt-4 flex justify-between items-center">
              <div class="text-sm text-gray-600">
                <span v-if="schedule.enabled" class="text-green-600 font-semibold">‚úì –ê–∫—Ç–∏–≤–Ω–æ</span>
                <span v-else class="text-gray-400">‚óã –û—Ç–∫–ª—é—á–µ–Ω–æ</span>
                <span v-if="schedule.enabled"> ‚Ä¢ –ó–∞–ø—É—Å–∫: {{ schedule.dailyRunTime }} ({{ schedule.timezone }})</span>
              </div>
              <button @click="saveSchedule"
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm font-semibold">
                üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
              </button>
            </div>
          </div>

          <div class="mb-4">
            <label class="block mb-2 font-semibold">–ü–∞–ø–∫–∏ –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫–∞ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
            <input v-model="foldersInput" @input="updateFolders" class="w-full border p-2 rounded">
          </div>

          <div class="mb-4">
            <label class="block mb-2 font-semibold">–ù–∞ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –≤–ø–µ—Ä–µ–¥?</label>
            <input type="number" min="1" max="30" v-model.number="config.daysToGenerate" autocomplete="off"
              class="w-full border p-2 rounded" placeholder="1">
            <p class="text-xs text-gray-500 mt-1">1 = —Ç–æ–ª—å–∫–æ —Å–µ–≥–æ–¥–Ω—è. 7 = –Ω–µ–¥–µ–ª—è.</p>
          </div>

          <h3 class="text-xl font-bold mt-6 mb-4">–õ–∏–º–∏—Ç—ã –ø–ª–∞—Ç—Ñ–æ—Ä–º (–ø–æ—Å—Ç–æ–≤ –≤ –¥–µ–Ω—å –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å)</h3>
          <div class="grid grid-cols-3 gap-4">
            <div>
              <label>Instagram</label>
              <input type="number" v-model="config.limits.instagram" class="w-full border p-2 rounded">
            </div>
            <div>
              <label>TikTok</label>
              <input type="number" v-model="config.limits.tiktok" class="w-full border p-2 rounded">
            </div>
            <div>
              <label>YouTube</label>
              <input type="number" v-model="config.limits.youtube" class="w-full border p-2 rounded">
            </div>
          </div>
        </div>

        <!-- PROFILES TAB -->
        <div v-if="currentTab === 'profiles'">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold">–°–æ—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏</h2>
            <div class="space-x-2">
              <button @click="syncProfiles" aria-label="–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª–∏ —Å UploadPost"
                class="text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded hover:bg-blue-200 focus-visible:ring-2 focus-visible:ring-blue-500">üîÑ
                –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å
                (UploadPost)</button>
              <button @click="fullResync" aria-label="–ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª–µ–π –∑–∞–Ω–æ–≤–æ"
                class="text-sm bg-red-100 text-red-700 px-3 py-1 rounded hover:bg-red-200 border border-red-300 focus-visible:ring-2 focus-visible:ring-red-500">
                ‚ö†Ô∏è –ü–æ–ª–Ω—ã–π –°–±—Ä–æ—Å (–°–∫–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ)
              </button>
              <button @click="addProfile" class="text-sm bg-gray-200 px-3 py-1 rounded hover:bg-gray-300">+ –î–æ–±–∞–≤–∏—Ç—å
                –ø—Ä–æ—Ñ–∏–ª—å</button>
            </div>
          </div>

          <!-- Active Profiles -->
          <div v-if="activeProfiles.length > 0">
            <div class="flex justify-between items-center mb-3 p-3 bg-gray-50 rounded">
              <button @click="showActiveProfiles = !showActiveProfiles"
                class="flex-1 text-left text-lg font-semibold hover:text-blue-600 flex items-center gap-2">
                <span>üü¢ –ê–∫—Ç–∏–≤–Ω—ã–µ –ü—Ä–æ—Ñ–∏–ª–∏ ({{ activeProfiles.length }})</span>
                <span class="text-xl">{{ showActiveProfiles ? '‚ñº' : '‚ñ∂' }}</span>
              </button>
              <div class="flex gap-2 text-sm" v-if="showActiveProfiles">
                <button @click="expandAllGroups(true)" class="text-blue-600 hover:underline">–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ</button>
                <span class="text-gray-300">|</span>
                <button @click="expandAllGroups(false)" class="text-blue-600 hover:underline">–°–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ</button>
              </div>
            </div>

            <!-- BULK ACTIONS BAR (Floating / Top) -->
            <div v-if="selectedProfiles.length > 0"
              class="sticky top-0 z-10 bg-blue-600 text-white p-4 rounded shadow-lg mb-4 flex justify-between items-center">
              <div class="font-bold">
                –í—ã–±—Ä–∞–Ω–æ –ø—Ä–æ—Ñ–∏–ª–µ–π: {{ selectedProfiles.length }}
              </div>
              <div class="flex items-center gap-2">
                <span>–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∫–æ –≤—Å–µ–º:</span>
                <select v-model="bulkThemeKey" class="p-1 px-2 rounded text-black w-40 border border-gray-300">
                  <option disabled value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>
                  <option v-for="theme in availableThemes" :key="theme" :value="theme">
                    {{ theme }}
                  </option>
                </select>
                <button @click="applyBulkCategory"
                  class="bg-white text-blue-600 font-bold px-4 py-1 rounded hover:bg-gray-100">
                  –ü—Ä–∏–º–µ–Ω–∏—Ç—å
                </button>

                <div class="border-l border-blue-400 pl-4 ml-2 flex items-center gap-2">
                  <span class="text-sm font-medium">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:</span>
                  <button @click="toggleBulkEnabled(true)"
                    class="bg-green-500 hover:bg-green-600 text-white font-bold px-3 py-1 rounded text-sm">
                    ‚úÖ –í–∫–ª—é—á–∏—Ç—å
                  </button>
                  <button @click="toggleBulkEnabled(false)"
                    class="bg-red-500 hover:bg-red-600 text-white font-bold px-3 py-1 rounded text-sm">
                    ‚ùå –í—ã–∫–ª—é—á–∏—Ç—å
                  </button>
                </div>
                <button @click="selectedProfiles = []" class="ml-4 text-sm text-blue-200 hover:text-white underline">
                  –°–±—Ä–æ—Å–∏—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ
                </button>
              </div>
            </div>

            <div v-if="showActiveProfiles">
              <div v-for="(profiles, theme) in groupedActiveProfiles" :key="theme"
                class="mb-4 border rounded overflow-hidden">
                <!-- Group Header -->
                <div
                  class="bg-blue-50 p-3 font-semibold flex justify-between items-center hover:bg-blue-100 transition-colors">
                  <div class="flex items-center gap-3 flex-1">
                    <input type="checkbox" :checked="profiles.every(p => selectedProfiles.includes(p.username))"
                      @change="toggleGroupSelection(profiles, $event.target.checked)"
                      class="w-5 h-5 rounded cursor-pointer" title="–í—ã–±—Ä–∞—Ç—å –≤—Å—é –≥—Ä—É–ø–ø—É">

                    <div @click="toggleGroup(theme)" class="flex items-center gap-2 cursor-pointer flex-1">
                      <span>üìÅ {{ theme }}</span>
                      <span class="bg-blue-200 text-blue-800 text-xs px-2 py-1 rounded-full">{{ profiles.length
                        }}</span>
                    </div>
                  </div>
                  <span @click="toggleGroup(theme)" class="text-gray-500 cursor-pointer p-2">{{ expandedGroups[theme]
                    ? '‚ñº' : '‚ñ∂' }}</span>
                </div>

                <!-- Group Content (Table) -->
                <div v-show="expandedGroups[theme]" class="border-t">
                  <table class="w-full border-collapse">
                    <thead class="bg-gray-50 text-xs text-gray-500 uppercase">
                      <tr>
                        <th class="p-3 w-8"><input type="checkbox"
                            @change="toggleGroupSelection(profiles, $event.target.checked)"
                            :checked="profiles.every(p => selectedProfiles.includes(p.username))"></th>
                        <th class="text-left p-3 w-12"></th>
                        <th class="text-left p-3">–ü—Ä–æ—Ñ–∏–ª—å</th>
                        <th class="text-left p-3">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                        <th class="text-left p-3">–ü–ª–∞—Ç—Ñ–æ—Ä–º—ã</th>
                        <th class="text-center p-3 w-14" title="Instagram –ø–æ—Å—Ç–æ–≤/–¥–µ–Ω—å">üì∏ IG</th>
                        <th class="text-center p-3 w-14" title="TikTok –ø–æ—Å—Ç–æ–≤/–¥–µ–Ω—å">üéµ TT</th>
                        <th class="text-center p-3 w-14" title="YouTube –ø–æ—Å—Ç–æ–≤/–¥–µ–Ω—å">üìπ YT</th>
                        <th class="text-center p-3 w-20">–í–∫–ª</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr v-for="profile in profiles" :key="profile.username" class="border-b hover:bg-gray-50"
                        :class="{'bg-blue-50': selectedProfiles.includes(profile.username)}">
                        <td class="p-3 text-center">
                          <input type="checkbox" :checked="selectedProfiles.includes(profile.username)"
                            @click="handleProfileSelect($event, profile, profiles)" class="w-4 h-4 cursor-pointer">
                        </td>
                        <td class="p-2 text-center text-xl" :title="'–ê–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å'">üü¢</td>
                        <td class="p-2 font-medium">
                          <input v-model="profile.username"
                            class="w-full border-b border-transparent hover:border-gray-300 p-1 bg-transparent"
                            placeholder="Username">
                        </td>
                        <td class="p-2">
                          <select v-model="profile.theme_key"
                            class="w-full border-b border-transparent hover:border-gray-300 p-1 bg-transparent text-sm">
                            <option value="" class="text-gray-400">–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                            <option v-for="theme in availableThemes" :key="theme" :value="theme">
                              {{ theme }}
                            </option>
                          </select>
                        </td>
                        <td class="p-2">
                          <div class="flex gap-1 flex-wrap">
                            <span v-for="platform in profile.platforms" :key="platform"
                              class="px-2 py-0.5 text-xs rounded border" :class="{
                                    'bg-pink-50 border-pink-200 text-pink-700': platform === 'instagram',
                                    'bg-blue-50 border-blue-200 text-blue-700': platform === 'tiktok',
                                    'bg-red-50 border-red-200 text-red-700': platform === 'youtube'
                                  }">
                              {{ platform }}
                            </span>
                            <span v-if="!profile.platforms || profile.platforms.length === 0"
                              class="text-gray-400 text-xs italic">
                              –ù–µ—Ç –ø–ª–∞—Ç—Ñ–æ—Ä–º
                            </span>
                            <span v-if="!profile.platforms || profile.platforms.length === 0"
                              class="text-gray-400 text-xs italic">
                              –ù–µ—Ç –ø–ª–∞—Ç—Ñ–æ—Ä–º
                            </span>
                          </div>
                        </td>
                        <td class="p-2 text-center">
                          <input type="number" min="0" max="50" v-model.number="profile.instagramLimit" placeholder="-"
                            class="w-12 border-b border-transparent hover:border-gray-300 p-1 bg-transparent text-center text-sm"
                            title="Instagram –ª–∏–º–∏—Ç (–ø—É—Å—Ç–æ = –≥–ª–æ–±–∞–ª—å–Ω—ã–π)">
                        </td>
                        <td class="p-2 text-center">
                          <input type="number" min="0" max="50" v-model.number="profile.tiktokLimit" placeholder="-"
                            class="w-12 border-b border-transparent hover:border-gray-300 p-1 bg-transparent text-center text-sm"
                            title="TikTok –ª–∏–º–∏—Ç (–ø—É—Å—Ç–æ = –≥–ª–æ–±–∞–ª—å–Ω—ã–π)">
                        </td>
                        <td class="p-2 text-center">
                          <input type="number" min="0" max="50" v-model.number="profile.youtubeLimit" placeholder="-"
                            class="w-12 border-b border-transparent hover:border-gray-300 p-1 bg-transparent text-center text-sm"
                            title="YouTube –ª–∏–º–∏—Ç (–ø—É—Å—Ç–æ = –≥–ª–æ–±–∞–ª—å–Ω—ã–π)">
                        </td>
                        <td class="p-2 text-center">
                          <label class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" :checked="profile.enabled !== false"
                              @change="toggleProfileEnabled(profile)" class="sr-only peer">
                            <div
                              class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600">
                            </div>
                          </label>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Disabled Profiles -->
          <div v-if="disabledProfiles.length > 0">
            <button @click="showDisabledProfiles = !showDisabledProfiles"
              class="w-full flex justify-between items-center text-lg font-semibold mb-3 p-3 bg-gray-50 hover:bg-gray-100 rounded text-gray-600">
              <span>‚ö´ –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ ({{ disabledProfiles.length }})</span>
              <span class="text-2xl">{{ showDisabledProfiles ? '‚ñº' : '‚ñ∂' }}</span>
            </button>

            <!-- BULK ACTIONS BAR for Disabled Profiles -->
            <div v-if="selectedDisabledProfiles.length > 0 && showDisabledProfiles"
              class="sticky top-0 z-10 bg-gray-600 text-white p-4 rounded shadow-lg mb-4 flex justify-between items-center">
              <div class="font-bold">
                –í—ã–±—Ä–∞–Ω–æ –ø—Ä–æ—Ñ–∏–ª–µ–π: {{ selectedDisabledProfiles.length }}
              </div>
              <div class="flex items-center gap-2">
                <span>–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∫–æ –≤—Å–µ–º:</span>
                <select v-model="bulkThemeKeyDisabled" class="p-1 px-2 rounded text-black w-40 border border-gray-300">
                  <option disabled value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>
                  <option v-for="theme in availableThemes" :key="theme" :value="theme">
                    {{ theme }}
                  </option>
                </select>
                <button @click="applyBulkCategoryDisabled"
                  class="bg-white text-gray-600 font-bold px-4 py-1 rounded hover:bg-gray-100">
                  –ü—Ä–∏–º–µ–Ω–∏—Ç—å
                </button>

                <div class="border-l border-gray-400 pl-4 ml-2 flex items-center gap-2">
                  <span class="text-sm font-medium">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:</span>
                  <label class="inline-flex items-center cursor-pointer">
                    <input type="checkbox"
                      :checked="selectedDisabledProfiles.some(u => config.profiles.find(p => p.username === u)?.enabled !== false)"
                      @change="toggleBulkEnabledDisabled($event.target.checked)" class="sr-only peer">
                    <div
                      class="relative w-11 h-6 bg-gray-800 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-gray-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-400">
                    </div>
                    <span class="ml-2 text-sm font-medium text-gray-100"
                      v-if="selectedDisabledProfiles.some(u => config.profiles.find(p => p.username === u)?.enabled !== false)">–í–ö–õ</span>
                    <span class="ml-2 text-sm font-medium text-gray-200" v-else>–í–´–ö–õ</span>
                  </label>
                </div>
                <button @click="selectedDisabledProfiles = []"
                  class="ml-4 text-sm text-gray-200 hover:text-white underline">
                  –°–±—Ä–æ—Å–∏—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ
                </button>
              </div>
            </div>

            <div v-if="showDisabledProfiles" class="opacity-60">
              <div v-for="(profiles, theme) in groupedDisabledProfiles" :key="theme"
                class="mb-4 border rounded overflow-hidden">
                <!-- Group Header -->
                <div
                  class="bg-gray-50 p-3 font-semibold flex justify-between items-center hover:bg-gray-100 transition-colors">
                  <div class="flex items-center gap-3 flex-1">
                    <input type="checkbox" :checked="profiles.every(p => selectedDisabledProfiles.includes(p.username))"
                      @change="toggleGroupSelectionDisabled(profiles, $event.target.checked)"
                      class="w-5 h-5 rounded cursor-pointer" title="–í—ã–±—Ä–∞—Ç—å –≤—Å—é –≥—Ä—É–ø–ø—É">

                    <div @click="toggleGroupDisabled(theme)" class="flex items-center gap-2 cursor-pointer flex-1">
                      <span>üìÅ {{ theme }}</span>
                      <span class="bg-gray-200 text-gray-800 text-xs px-2 py-1 rounded-full">{{ profiles.length
                        }}</span>
                    </div>
                  </div>
                  <span @click="toggleGroupDisabled(theme)" class="text-gray-500 cursor-pointer p-2">{{
                    expandedGroupsDisabled[theme]
                    ? '‚ñº' : '‚ñ∂' }}</span>
                </div>

                <!-- Group Content (Table) -->
                <div v-show="expandedGroupsDisabled[theme]" class="border-t">
                  <table class="w-full border-collapse">
                    <thead class="bg-gray-50 text-xs text-gray-500 uppercase">
                      <tr>
                        <th class="p-3 w-8"><input type="checkbox"
                            @change="toggleGroupSelectionDisabled(profiles, $event.target.checked)"
                            :checked="profiles.every(p => selectedDisabledProfiles.includes(p.username))"></th>
                        <th class="text-left p-3 w-12"></th>
                        <th class="text-left p-3">–ü—Ä–æ—Ñ–∏–ª—å</th>
                        <th class="text-left p-3">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                        <th class="text-left p-3">–ü–ª–∞—Ç—Ñ–æ—Ä–º—ã</th>
                        <th class="text-left p-3 w-20">–õ–∏–º–∏—Ç</th>
                        <th class="text-center p-3 w-32">–î–µ–π—Å—Ç–≤–∏—è</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr v-for="profile in profiles" :key="profile.username" class="border-b hover:bg-gray-50"
                        :class="{'bg-gray-100': selectedDisabledProfiles.includes(profile.username)}">
                        <td class="p-3 text-center">
                          <input type="checkbox" :checked="selectedDisabledProfiles.includes(profile.username)"
                            @click="handleProfileSelectDisabled($event, profile, profiles)"
                            class="w-4 h-4 cursor-pointer">
                        </td>
                        <td class="p-2 text-center text-xl" :title="'–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω'">‚ö´</td>
                        <td class="p-2 font-medium text-gray-500">{{ profile.username }}</td>
                        <td class="p-2 text-gray-500">{{ profile.theme_key }}</td>
                        <td class="p-2">
                          <div class="flex gap-2">
                            <span v-for="platform in profile.platforms" :key="platform"
                              class="px-2 py-1 text-xs rounded bg-gray-200 text-gray-600">
                              {{ platform === 'instagram' ? 'Instagram' : platform === 'tiktok' ? 'TikTok' : 'YouTube'
                              }}
                            </span>
                          </div>
                        </td>
                        <td class="p-2 text-gray-400 text-center">
                          {{ profile.limit || '-' }}
                        </td>
                        <td class="p-2 text-center">
                          <label class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" :checked="profile.enabled !== false"
                              @change="toggleProfileEnabled(profile)" class="sr-only peer">
                            <div
                              class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600">
                            </div>
                          </label>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- CLIENTS TAB -->
        <div v-if="currentTab === 'clients'">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold">–ö–ª–∏–µ–Ω—Ç—ã –∏ –ü—Ä–æ–º—Ç—ã (AI)</h2>
            <button @click="addClient" class="text-sm bg-gray-200 px-3 py-1 rounded hover:bg-gray-300">+ –î–æ–±–∞–≤–∏—Ç—å
              –∫–ª–∏–µ–Ω—Ç–∞</button>
          </div>

          <div v-for="(client, idx) in config.clients" :key="idx" class="border p-4 rounded mb-4 bg-gray-50">
            <div class="grid grid-cols-3 gap-4 mb-2">
              <div>
                <label class="text-sm text-gray-500 block">–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞ (–±—Ä–µ–Ω–¥)</label>
                <input v-model="client.name" class="w-full border p-2 rounded">
              </div>
              <div>
                <label class="text-sm text-gray-500 block">Regex –ø–∞–ø–∫–∏</label>
                <input v-model="client.regex" class="w-full border p-2 rounded font-mono">
              </div>
              <div>
                <label class="text-sm text-gray-500 block">–ö–≤–æ—Ç–∞ (–≤–∏–¥–µ–æ/–º–µ—Å—è—Ü)</label>
                <input v-model.number="client.quota" type="number" min="0" class="w-full border p-2 rounded"
                  placeholder="30">
                <div v-if="client.quota" class="mt-2">
                  <div class="text-xs text-gray-600 mb-1">
                    <span class="font-semibold">{{ getClientPublished(client) }}</span> / {{ client.quota }}
                    –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ
                    <span class="text-green-600 ml-2">(–æ—Å—Ç–∞–ª–æ—Å—å: {{ getClientRemaining(client) }})</span>
                  </div>
                  <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                    <div class="bg-blue-500 h-full transition-all" :style="{ width: getClientProgress(client) + '%' }">
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div>
              <label class="text-sm text-gray-500 block">AI –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º—Ç</label>
              <textarea v-model="client.prompt" class="w-full border p-2 rounded h-32 font-mono text-sm"></textarea>
            </div>
            <div class="text-right mt-2">
              <button @click="removeClient(idx)" class="text-red-500 text-sm hover:underline">–£–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</button>
            </div>
          </div>
        </div>

        <!-- ANALYTICS TAB -->
        <div v-if="currentTab === 'analytics'">
          <div class="flex justify-between items-center mb-6">
            <div>
              <h2 class="text-2xl font-bold flex items-center gap-2">
                üìä –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
                <span v-if="analytics.loading"
                  class="text-sm font-normal text-gray-500 animate-pulse">(–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...)</span>
              </h2>
              <div class="text-sm text-gray-500 mt-1">
                –î–∞–Ω–Ω—ã–µ –∑–∞: <span class="font-medium text-gray-700">{{ analytics.date ? new
                  Date(analytics.date).toLocaleDateString() : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' }}</span>
              </div>
            </div>

            <button @click="refreshAnalytics"
              class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded flex items-center gap-2 shadow-sm transition-colors"
              :disabled="analytics.loading">
              <span v-if="analytics.loading" class="animate-spin">üîÑ</span>
              <span v-else>üîÑ</span>
              –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
            </button>
          </div>

          <div v-if="!analytics.date && !analytics.loading"
            class="text-center py-12 bg-gray-50 rounded-lg border border-dashed border-gray-300">
            <div class="text-4xl mb-2">üìâ</div>
            <h3 class="text-lg font-medium text-gray-600">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∞–Ω–∞–ª–∏—Ç–∏–∫–∏</h3>
            <p class="text-gray-500 mb-4">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, —á—Ç–æ–±—ã —Å–æ–±—Ä–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É.</p>
            <button @click="refreshAnalytics" class="text-blue-600 hover:underline">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö</button>
          </div>

          <div v-else class="grid grid-cols-1 md:grid-cols-3 gap-6">

            <!-- INSTAGRAM -->
            <div
              class="bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl shadow-lg text-white p-6 relative overflow-hidden">
              <div class="absolute top-0 right-0 p-4 opacity-20 text-6xl">
                <i class="fab fa-instagram"></i> üì∏
              </div>
              <h3 class="text-lg font-semibold uppercase tracking-wider mb-4 border-b border-white/20 pb-2">Instagram
              </h3>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <div class="text-purple-100 text-sm mb-1">–§–æ–ª–ª–æ–≤–µ—Ä—ã</div>
                  <div class="text-3xl font-bold">{{ (analytics.platforms.instagram?.followers || 0).toLocaleString() }}
                  </div>
                </div>
                <div>
                  <div class="text-purple-100 text-sm mb-1">–û—Ö–≤–∞—Ç—ã (Reach)</div>
                  <div class="text-3xl font-bold">{{ (analytics.platforms.instagram?.reach || 0).toLocaleString() }}
                  </div>
                </div>
              </div>
              <div class="mt-4 text-xs text-purple-200">
                –ê–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π: {{ analytics.platforms.instagram?.profiles || 0 }}
              </div>
            </div>

            <!-- TIKTOK -->
            <div
              class="bg-gradient-to-br from-gray-800 to-black rounded-xl shadow-lg text-white p-6 relative overflow-hidden">
              <div class="absolute top-0 right-0 p-4 opacity-20 text-6xl">
                üéµ
              </div>
              <h3 class="text-lg font-semibold uppercase tracking-wider mb-4 border-b border-white/20 pb-2">TikTok</h3>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <div class="text-gray-400 text-sm mb-1">–§–æ–ª–ª–æ–≤–µ—Ä—ã</div>
                  <div class="text-3xl font-bold">{{ (analytics.platforms.tiktok?.followers || 0).toLocaleString() }}
                  </div>
                </div>
                <div>
                  <div class="text-gray-400 text-sm mb-1">–ü—Ä–æ—Å–º–æ—Ç—Ä—ã</div>
                  <div class="text-3xl font-bold">{{ (analytics.platforms.tiktok?.reach || 0).toLocaleString() }}</div>
                </div>
              </div>
              <div class="mt-4 text-xs text-gray-500">
                –ê–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π: {{ analytics.platforms.tiktok?.profiles || 0 }}
              </div>
            </div>

            <!-- YOUTUBE -->
            <div
              class="bg-gradient-to-br from-red-600 to-red-700 rounded-xl shadow-lg text-white p-6 relative overflow-hidden">
              <div class="absolute top-0 right-0 p-4 opacity-20 text-6xl">
                ‚ñ∂Ô∏è
              </div>
              <h3 class="text-lg font-semibold uppercase tracking-wider mb-4 border-b border-white/20 pb-2">YouTube</h3>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <div class="text-red-200 text-sm mb-1">–ü–æ–¥–ø–∏—Å—á–∏–∫–∏</div>
                  <div class="text-3xl font-bold">{{ (analytics.platforms.youtube?.followers || 0).toLocaleString() }}
                  </div>
                </div>
                <div>
                  <div class="text-red-200 text-sm mb-1">–ü—Ä–æ—Å–º–æ—Ç—Ä—ã</div>
                  <div class="text-3xl font-bold">{{ (analytics.platforms.youtube?.reach || 0).toLocaleString() }}</div>
                </div>
              </div>
              <div class="mt-4 text-xs text-red-200">
                –ê–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π: {{ analytics.platforms.youtube?.profiles || 0 }}
              </div>
            </div>

            <!-- TOTAL SUMMARY -->
            <div class="md:col-span-3 bg-white border border-gray-200 rounded-xl p-6 shadow-sm">
              <h3 class="text-gray-500 uppercase text-xs font-bold tracking-widest mb-4">–°–≤–æ–¥–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
              <div class="flex flex-wrap gap-8 justify-around">
                <div class="text-center">
                  <div class="text-4xl font-bold text-gray-800">
                    {{
                    ((analytics.platforms.instagram?.followers || 0) +
                    (analytics.platforms.tiktok?.followers || 0) +
                    (analytics.platforms.youtube?.followers || 0)).toLocaleString()
                    }}
                  </div>
                  <div class="text-gray-400 text-sm uppercase mt-2">–í—Å–µ–≥–æ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤</div>
                </div>
                <div class="text-center">
                  <div class="text-4xl font-bold text-gray-800">
                    {{
                    ((analytics.platforms.instagram?.reach || 0) +
                    (analytics.platforms.tiktok?.reach || 0) +
                    (analytics.platforms.youtube?.reach || 0)).toLocaleString()
                    }}
                  </div>
                  <div class="text-gray-400 text-sm uppercase mt-2">–û–±—â–∏–π –æ—Ö–≤–∞—Ç / –ø—Ä–æ—Å–º–æ—Ç—Ä—ã</div>
                </div>
              </div>
            </div>

          </div>
        </div>

        <!-- LOGS TAB -->
        <div v-if="currentTab === 'logs'">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold">üìã –õ–æ–≥–∏ —Å–∏—Å—Ç–µ–º—ã</h2>
            <div class="flex gap-2">
              <label class="flex items-center gap-2 text-sm">
                <input type="checkbox" v-model="logsAutoRefresh" class="rounded">
                <span>–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (3 —Å–µ–∫)</span>
              </label>
              <button @click="loadLogs" aria-label="–û–±–Ω–æ–≤–∏—Ç—å –ª–æ–≥–∏ —Å–∏—Å—Ç–µ–º—ã"
                class="text-sm bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 focus-visible:ring-2 focus-visible:ring-blue-300">
                üîÑ –û–±–Ω–æ–≤–∏—Ç—å
              </button>
            </div>
          </div>

          <div v-if="logsLoading" class="text-center text-gray-500 py-8">
            –ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤...
          </div>

          <div v-else-if="!logsSuccess" class="bg-yellow-50 border border-yellow-200 rounded p-4 mb-4">
            <p class="text-yellow-800">‚ö†Ô∏è {{ logsMessage }}</p>
            <p class="text-sm text-yellow-700 mt-2">
              –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª–æ–≥–∏ Docker/EasyPanel –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤—ã–≤–æ–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
            </p>
          </div>

          <div v-else class="bg-gray-900 text-green-400 p-4 rounded font-mono text-xs overflow-auto"
            style="max-height: 600px;">
            <div v-for="(line, idx) in logs" :key="idx" class="hover:bg-gray-800">
              {{ line }}
            </div>
            <div v-if="logs.length === 0" class="text-gray-500 text-center py-4">
              –õ–æ–≥–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç
            </div>
          </div>
        </div>


        <script>
          const { createApp } = Vue;

          createApp({
            data() {
              return {
                currentTab: 'dashboard',
                tabs: [
                  { id: 'dashboard', name: '–î–∞—à–±–æ—Ä–¥' },
                  { id: 'stats', name: '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞' },
                  { id: 'settings', name: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏' },
                  { id: 'profiles', name: '–ü—Ä–æ—Ñ–∏–ª–∏' },
                  { id: 'clients', name: 'AI –ö–ª–∏–µ–Ω—Ç—ã' },
                  { id: 'logs', name: 'üìã –õ–æ–≥–∏' }
                ],
                config: {
                  cronSchedule: '',
                  daysToGenerate: 1, // Default for safety
                  yandexFolders: [],
                  limits: { instagram: 0, tiktok: 0, youtube: 0 },
                  profiles: [],
                  clients: []
                },
                stats: {
                  totalVideos: 0,
                  publishedCount: 0,
                  byCategory: {},
                  byAuthor: {},
                  byBrand: {},
                  profilesByCategory: {},
                  profilesByAuthor: {},
                  profilesByBrand: {}
                },
                brandStats: {},
                currentMonth: new Date().toISOString().substring(0, 7),
                statsSummary: null,
                todayStats: {
                  date: '--',
                  time_msk: '--:--',
                  success_count: 0,
                  failed_count: 0,
                  queued_count: 0,
                  profiles_count: 0
                },
                loading: true,
                statsLoading: false,
                statsViewMode: 'category', // 'category' or 'author'
                foldersInput: '',
                newThemeKey: '',
                showActiveProfiles: true,    // Collapsible - active by default
                showDisabledProfiles: false,  // Collapsible - collapsed by default
                expandedGroups: {}, // For accordion view
                expandedGroupsDisabled: {}, // For disabled profiles accordion
                selectedProfiles: [], // List of selected usernames for bulk actions
                logs: [],
                logsLoading: false,
                logsSuccess: true,
                logsMessage: '',
                logsAutoRefresh: false,
                logsRefreshInterval: null,
                selectedDisabledProfiles: [], // List of selected disabled profiles for bulk actions
                lastSelected: null, // For Shift+Click
                lastSelectedDisabled: null, // For Shift+Click in disabled profiles
                bulkThemeKey: '', // Model for bulk edit input
                bulkThemeKeyDisabled: '', // Model for bulk edit input (disabled profiles)
                schedule: {
                  enabled: false,
                  timezone: 'Europe/Moscow',
                  dailyRunTime: '00:01'
                },
                realtime: {
                  connected: false,
                  eventSource: null,
                  reconnectTimer: null
                },
                autoRefreshIntervals: {
                  today: null,
                  dashboard: null
                },
                errors: [],
                analytics: {
                  loading: false,
                  date: null,
                  platforms: {}
                }
              }
            },
            async mounted() {
              await this.loadConfig();
              this.loadSchedule();
              this.loadStats();
              this.loadTodayStats();
              this.loadTodayStats();
              this.loadErrors();
              this.fetchStatsSummary();
              this.loadBrandStats();

              this.loadBrandStats();

              this.loadGlobalAnalytics();

              // Initialize Real-Time Updates
              this.setupSSE();

              // Auto-refresh timers
              // 1. Today Stats: every 30 seconds
              this.autoRefreshIntervals.today = setInterval(() => {
                this.loadTodayStats();
                this.loadErrors();
                // Also refresh logs if visible
                if (this.currentTab === 'logs' && this.logsAutoRefresh) this.loadLogs();
              }, 30000);

              // 2. Dashboard General Stats: every 60 seconds
              this.autoRefreshIntervals.dashboard = setInterval(() => this.loadStats(), 60000);
            },
            beforeUnmount() {
              // Cleanup
              if (this.realtime.eventSource) this.realtime.eventSource.close();
              if (this.autoRefreshIntervals.today) clearInterval(this.autoRefreshIntervals.today);
              if (this.autoRefreshIntervals.dashboard) clearInterval(this.autoRefreshIntervals.dashboard);
            },
            computed: {
              currentStatsList() {
                let source = {};
                if (this.statsViewMode === 'author') source = this.stats.byAuthor || {};
                else if (this.statsViewMode === 'brand') source = this.stats.byBrand || {};
                else source = this.stats.byCategory || {};

                return Object.entries(source)
                  .map(([name, count]) => ({ name, count }))
                  .filter(item => item.name !== 'unknown') // Exclude files outside hierarchy
                  .sort((a, b) => a.name.localeCompare(b.name));
              },
              statsHeader() {
                if (this.statsViewMode === 'category') return '–ö–∞—Ç–µ–≥–æ—Ä–∏—è';
                if (this.statsViewMode === 'brand') return '–ë—Ä–µ–Ω–¥';
                return '–ê–≤—Ç–æ—Ä';
              },
              activeProfiles() {
                if (!this.config.profiles) return [];
                return this.config.profiles.filter(p => p.enabled !== false);
              },
              disabledProfiles() {
                if (!this.config.profiles) return [];
                return this.config.profiles.filter(p => p.enabled === false);
              },
              groupedActiveProfiles() {
                const groups = {};
                this.activeProfiles.forEach(p => {
                  // Create a consistent key
                  const key = (p.theme_key || '–ë–µ–∑ —Ç–µ–º—ã').toLowerCase().trim();
                  // Capitalize for display
                  const displayKey = key.charAt(0).toUpperCase() + key.slice(1);

                  if (!groups[displayKey]) groups[displayKey] = [];
                  groups[displayKey].push(p);
                });

                // Sort keys alphabetically
                return Object.keys(groups).sort().reduce((acc, key) => {
                  acc[key] = groups[key];
                  return acc;
                }, {});
              },
              groupedDisabledProfiles() {
                const groups = {};
                this.disabledProfiles.forEach(p => {
                  const key = (p.theme_key || '–ë–µ–∑ —Ç–µ–º—ã').toLowerCase().trim();
                  const displayKey = key.charAt(0).toUpperCase() + key.slice(1);
                  if (!groups[displayKey]) groups[displayKey] = [];
                  groups[displayKey].push(p);
                });
                return Object.keys(groups).sort().reduce((acc, key) => {
                  acc[key] = groups[key];
                  return acc;
                }, {});
              },
              availableThemes() {
                // Source strictly from config.themeAliases (which is auto-populated from Yandex Stats)
                if (this.config && this.config.themeAliases) {
                  return Object.keys(this.config.themeAliases).sort();
                }
                return [];
              },
              groupedErrors() {
                // Group errors by (Profile + VideoName) to combine platform errors
                const grouped = {};

                this.errors.forEach(err => {
                  const key = `${err.profile_username}|${err.video_name}`;
                  if (!grouped[key]) {
                    grouped[key] = {
                      profile: err.profile_username,
                      video: err.video_name,
                      platforms: [],
                      timestamp: err.timestamp,
                      messages: []
                    };
                  }
                  grouped[key].platforms.push(err.platform);
                  if (!grouped[key].messages.includes(err.error)) {
                    grouped[key].messages.push(err.error);
                  }
                });

                return Object.values(grouped).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
              }
            },
            methods: {
              getProfilesForCategory(categoryName) {
                // Get profiles based on current view mode
                const key = categoryName.toLowerCase().trim();

                if (this.statsViewMode === 'author') {
                  return this.stats.profilesByAuthor?.[key] || [];
                } else if (this.statsViewMode === 'brand') {
                  return this.stats.profilesByBrand?.[key] || [];
                } else {
                  // category mode
                  return this.stats.profilesByCategory?.[key] || [];
                }
              },
              getPublishedCount(name) {
                // Try to find matching brand stat
                // name is the Brand Name or Category Name from Yandex scan
                const cleanName = name.toLowerCase().replace(" ", "");

                // Search in this.brandStats (which is Keyed by "category:brand")
                // If we are in 'brand' mode, we need to sum up all stats where brand == name
                // If we are in 'category' mode, we sum up all stats where category == name

                let total = 0;
                Object.entries(this.brandStats).forEach(([key, val]) => {
                  const [cat, br] = key.split(':');
                  if (this.statsViewMode === 'brand') {
                    if (br === cleanName) total += val.published_count || 0;
                  } else if (this.statsViewMode === 'category') {
                    if (cat === cleanName) total += val.published_count || 0;
                  }
                });
                return total > 0 ? total : '-';
              },
              async loadTodayStats() {
                try {
                  const res = await fetch('/api/stats/today');
                  if (res.ok) {
                    this.todayStats = await res.json();
                  }
                } catch (e) {
                  console.error('Failed to load today stats:', e);
                }
              },
              async loadStats() {
                this.statsLoading = true;
                try {
                  const res = await fetch('/api/stats');
                  if (res.ok) {
                    this.stats = await res.json();

                    // Auto-persist found folders as themes
                    let changed = false;
                    if (!this.config.themeAliases) this.config.themeAliases = {};

                    const foundFolders = Object.keys(this.stats.byCategory || {});
                    foundFolders.forEach(folder => {
                      // Use exact folder name as key
                      // If not exists, add it.
                      // We don't delete old ones automatically to preserve history? 
                      // User said "upsert or add new". Cleaning old ones isn't explicitly requested but safe to keep.
                      if (!this.config.themeAliases[folder]) {
                        this.config.themeAliases[folder] = [folder]; // Default alias is itself
                        changed = true;
                      }
                    });

                    if (changed) {
                      this.saveConfig();
                      // No alert needed, just silent save
                    }
                  }
                } catch (e) {
                  console.error('Failed to load stats', e);
                } finally {
                  this.statsLoading = false;
                }
              },
              async fetchStatsSummary() {
                try {
                  const res = await fetch('/api/stats/summary');
                  const data = await res.json();
                  if (data.success) {
                    this.statsSummary = data.stats;
                  }
                } catch (error) {
                  console.error('Failed to fetch stats summary:', error);
                }
              },
              async loadErrors() {
                try {
                  const res = await fetch('/api/stats/errors');
                  if (res.ok) {
                    const data = await res.json();
                    this.errors = data.errors || [];
                  }
                } catch (e) {
                  console.error('Failed to load errors:', e);
                }
              },
              async loadConfig() {
                this.loading = true;
                try {
                  const res = await fetch('/api/config');
                  if (!res.ok) {
                    throw new Error(`Server returned ${res.status}`);
                  }
                  const data = await res.json();
                  // Ensure structure and merge with defaults
                  this.config = {
                    profiles: [],
                    clients: [],
                    limits: { instagram: 10, tiktok: 10, youtube: 2 },
                    yandexFolders: [],
                    ...this.config, // Keep existing if any? No, we want server data.
                    ...data // Overwrite with server data
                  };

                  // Explicitly ensure deep objects if missing from server data
                  if (!this.config.profiles) this.config.profiles = [];
                  if (!this.config.clients) this.config.clients = [];
                  if (!this.config.limits) this.config.limits = { instagram: 10, tiktok: 10, youtube: 2 };

                  this.foldersInput = (this.config.yandexFolders || []).join(', ');
                } catch (e) {
                  console.error('[UI] Failed to load config:', e);
                  // alert('Failed to load config (using defaults)');
                  // Keep default config structure
                } finally {
                  this.loading = false;
                }
              },
              async saveConfig() {
                try {
                  await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.config)
                  });
                  alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!');
                } catch (e) {
                  alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                }
              },
              async loadSchedule() {
                try {
                  const res = await fetch('/api/schedule');
                  if (res.ok) {
                    const data = await res.json();
                    this.schedule = {
                      enabled: data.enabled || false,
                      timezone: data.timezone || 'Europe/Moscow',
                      dailyRunTime: data.dailyRunTime || '00:01'
                    };
                  }
                } catch (e) {
                  console.error('[UI] Failed to load schedule:', e);
                }
              },
              async saveSchedule() {
                try {
                  const res = await fetch('/api/schedule', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.schedule)
                  });

                  if (res.ok) {
                    alert('‚úÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!');
                    // Reload full config to update local cronSchedule state
                    await this.loadConfig();
                  } else {
                    const error = await res.json();
                    alert(`‚ùå –û—à–∏–±–∫–∞: ${error.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å'}`);
                  }
                } catch (e) {
                  console.error('[UI] Failed to save schedule:', e);
                  alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è');
                }
              },
              async triggerRun(testMode = false) {
                // Ensure current state is saved before running
                await this.saveConfig();

                if (!confirm(testMode ? '–ó–∞–ø—É—Å—Ç–∏—Ç—å –≤ –¢–ï–°–¢–û–í–û–ú —Ä–µ–∂–∏–º–µ (–ø–æ 1 –ø–æ—Å—Ç—É –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É)?' : '–ó–∞–ø—É—Å—Ç–∏—Ç—å –ü–û–õ–ù–´–ô —Ü–∏–∫–ª –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏?')) return;
                try {
                  await fetch('/api/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ testMode })
                  });
                  alert('–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –∑–∞–ø—É—â–µ–Ω–∞ –≤ —Ñ–æ–Ω–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞.');
                } catch (e) {
                  alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å');
                }
              },
              async syncProfiles() {
                console.log('[UI] Sync button clicked');
                try {
                  const res = await fetch('/api/profiles/sync');
                  const data = await res.json();
                  console.log('[UI] Sync response:', data);

                  if (data.success && data.profiles) {
                    let addedCount = 0;

                    data.profiles.forEach(apiProfile => {
                      // Find existing profile by username
                      const existingProfile = this.config.profiles.find(p => p.username === apiProfile.username);

                      // Get platforms from API (keys of social_accounts where value is not empty)
                      const platforms = Object.entries(apiProfile.social_accounts || {})
                        .filter(([_, value]) => !!value) // Filter out empty strings/nulls
                        .map(([key]) => key);

                      if (platforms.length === 0) platforms.push('instagram'); // Default fallback

                      if (existingProfile) {
                        // Update existing profile's platforms if needed (merge or overwrite)
                        // We overwrite to ensure it reflects current state
                        existingProfile.platforms = platforms;
                      } else {
                        // Add new profile
                        this.config.profiles.push({
                          username: apiProfile.username,
                          theme_key: '',
                          platforms: platforms,
                          enabled: true
                        });
                        addedCount++;
                      }
                    });

                    alert(`–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –î–æ–±–∞–≤–ª–µ–Ω–æ –Ω–æ–≤—ã—Ö: ${addedCount}. –û–±–Ω–æ–≤–ª–µ–Ω—ã –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã —É —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö.`);
                    this.saveConfig();
                  } else {
                    console.error('[UI] Sync failed:', data.error);
                    alert('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                  }
                } catch (e) {
                  console.error('[UI] Fetch error:', e);
                  alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª–∏ (—Å–º. –∫–æ–Ω—Å–æ–ª—å)');
                }
              },
              async fullResync() {
                if (!confirm("–í–ù–ò–ú–ê–ù–ò–ï! \n–≠—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π (Smart, Toplash –∏ –¥—Ä.) –¥–ª—è –ø—Ä–æ—Ñ–∏–ª–µ–π.\n–°–ø–∏—Å–æ–∫ –ø—Ä–æ—Ñ–∏–ª–µ–π –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞—á–∏—Å—Ç–æ –∏–∑ UploadPost.\n\n–í—ã —É–≤–µ—Ä–µ–Ω—ã?")) return;

                this.config.profiles = []; // Clear all local profiles
                await this.syncProfiles(); // Fetch fresh
                this.saveConfig(); // Save the new clean state
              },
              updateFolders() {
                this.config.yandexFolders = this.foldersInput.split(',').map(s => s.trim()).filter(Boolean);
              },
              addProfile() {
                this.config.profiles.push({
                  username: '',
                  theme_key: '',
                  platforms: [] // Start with empty array, user will check boxes
                });
              },
              toggleProfileEnabled(profile) {
                // Toggle between enabled=true and enabled=false
                profile.enabled = profile.enabled === false ? true : false;
                this.saveConfig();
              },
              removeProfile(idx) {
                this.config.profiles.splice(idx, 1);
              },
              toggleBulkEnabled(enable) {
                this.selectedProfiles.forEach(username => {
                  const profile = this.config.profiles.find(p => p.username === username);
                  if (profile) {
                    profile.enabled = enable;
                  }
                });
                this.saveConfig();
                this.selectedProfiles = [];
                // No alert, just UI update
              },
              addClient() {
                this.config.clients.push({ name: 'New Client', regex: '', prompt: '' });
              },
              removeClient(idx) {
                this.config.clients.splice(idx, 1);
              },
              async loadBrandStats() {
                try {
                  const res = await fetch(`/api/brands/stats?month=${this.currentMonth}`);
                  if (res.ok) {
                    const data = await res.json();
                    this.brandStats = data.stats || {};
                  }
                } catch (e) {
                  console.error('[UI] Failed to load brand stats:', e);
                }
              },
              getClientPublished(client) {
                if (!client.name || !client.regex) return 0;
                const categoryMatch = client.regex.match(/([a-zA-Z–∞-—è–ê-–Ø0-9]+)/);
                const category = categoryMatch ? categoryMatch[1].toLowerCase() : 'unknown';
                const brandName = client.name.toLowerCase().replace(/[^a-z–∞-—è0-9]/g, '');
                const key = `${category}:${brandName}`;
                return this.brandStats[key]?.published_count || 0;
              },
              getClientRemaining(client) {
                const quota = client.quota || 0;
                const published = this.getClientPublished(client);
                return Math.max(0, quota - published);
              },
              getClientProgress(client) {
                const quota = client.quota || 0;
                if (quota === 0) return 0;
                const published = this.getClientPublished(client);
                return Math.min(100, Math.round((published / quota) * 100));
              },
              toggleGroupDisabled(theme) {
                this.expandedGroupsDisabled[theme] = !this.expandedGroupsDisabled[theme];
              },
              toggleGroupSelectionDisabled(profiles, checked) {
                profiles.forEach(p => {
                  const idx = this.selectedDisabledProfiles.indexOf(p.username);
                  if (checked && idx === -1) {
                    this.selectedDisabledProfiles.push(p.username);
                  } else if (!checked && idx !== -1) {
                    this.selectedDisabledProfiles.splice(idx, 1);
                  }
                });
              },
              handleProfileSelectDisabled(event, profile, groupProfiles) {
                const username = profile.username;
                const idx = this.selectedDisabledProfiles.indexOf(username);

                if (event.shiftKey && this.lastSelectedDisabled) {
                  const lastIdx = groupProfiles.findIndex(p => p.username === this.lastSelectedDisabled);
                  const currentIdx = groupProfiles.findIndex(p => p.username === username);
                  const [start, end] = lastIdx < currentIdx ? [lastIdx, currentIdx] : [currentIdx, lastIdx];

                  for (let i = start; i <= end; i++) {
                    const u = groupProfiles[i].username;
                    if (!this.selectedDisabledProfiles.includes(u)) {
                      this.selectedDisabledProfiles.push(u);
                    }
                  }
                } else {
                  if (idx === -1) {
                    this.selectedDisabledProfiles.push(username);
                  } else {
                    this.selectedDisabledProfiles.splice(idx, 1);
                  }
                }
                this.lastSelectedDisabled = username;
              },
              async applyBulkCategoryDisabled() {
                if (!this.bulkThemeKeyDisabled) return;
                this.selectedDisabledProfiles.forEach(username => {
                  const profile = this.config.profiles.find(p => p.username === username);
                  if (profile) {
                    profile.theme_key = this.bulkThemeKeyDisabled;
                  }
                });
                await this.saveConfig();
                this.bulkThemeKeyDisabled = '';
              },
              async toggleBulkEnabledDisabled(enabled) {
                this.selectedDisabledProfiles.forEach(username => {
                  const profile = this.config.profiles.find(p => p.username === username);
                  if (profile) {
                    profile.enabled = enabled;
                  }
                });
                await this.saveConfig();
              },
              updateAliases(key, value) {
                const arr = value.split(',').map(s => s.trim()).filter(s => s.length > 0);
                this.config.themeAliases[key] = arr;
              },
              addThemeKey() {
                if (!this.newThemeKey) return;
                const key = this.newThemeKey.toLowerCase().trim();
                if (this.config.themeAliases[key]) {
                  alert('–ì—Ä—É–ø–ø–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!');
                  return;
                }
                this.config.themeAliases[key] = [key];
                this.newThemeKey = '';
              },
              deleteThemeKey(key) {
                if (confirm(`–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É '${key}'?`)) {
                  delete this.config.themeAliases[key];
                }
              },
              deleteTheme(key) {
                // Alias for deleteThemeKey for backward compatibility if template calls it
                this.deleteThemeKey(key);
              },
              toggleGroup(key) {
                this.expandedGroups[key] = !this.expandedGroups[key];
              },
              expandAllGroups(expand) {
                const keys = Object.keys(this.groupedActiveProfiles);
                keys.forEach(key => {
                  this.expandedGroups[key] = expand;
                });
              },
              handleProfileSelect(event, profile, groupProfiles) {
                const username = profile.username;
                const isSelected = this.selectedProfiles.includes(username);
                // Standard checkbox behavior toggles value. 
                // But since we use @click, we need to know what the NEW state will be.
                // If it was selected, it will become unselected.
                // Note: browser checkbox toggles visually on click immediately.
                // We just need to sync our array.

                let targetState = !isSelected;

                // Use event.shiftKey to detect range selection
                if (event.shiftKey && this.lastSelected) {
                  const lastIdx = groupProfiles.findIndex(p => p.username === this.lastSelected);
                  const currIdx = groupProfiles.findIndex(p => p.username === username);

                  if (lastIdx !== -1 && currIdx !== -1) {
                    const start = Math.min(lastIdx, currIdx);
                    const end = Math.max(lastIdx, currIdx);

                    const range = groupProfiles.slice(start, end + 1);

                    range.forEach(p => {
                      const idx = this.selectedProfiles.indexOf(p.username);
                      if (targetState && idx === -1) {
                        this.selectedProfiles.push(p.username);
                      } else if (!targetState && idx !== -1) {
                        this.selectedProfiles.splice(idx, 1);
                      }
                    });
                  } else {
                    this.toggleSelectionSingle(username, targetState);
                  }
                } else {
                  this.toggleSelectionSingle(username, targetState);
                }

                this.lastSelected = username;
              },
              toggleSelectionSingle(username, state) {
                const idx = this.selectedProfiles.indexOf(username);
                if (state && idx === -1) {
                  this.selectedProfiles.push(username);
                } else if (!state && idx !== -1) {
                  this.selectedProfiles.splice(idx, 1);
                }
              },
              toggleGroupSelection(profiles, checked) {
                if (checked) {
                  // Add all profiles in group to selection
                  profiles.forEach(p => {
                    if (!this.selectedProfiles.includes(p.username)) {
                      this.selectedProfiles.push(p.username);
                    }
                  });
                } else {
                  // Remove all profiles in group from selection
                  profiles.forEach(p => {
                    const idx = this.selectedProfiles.indexOf(p.username);
                    if (idx > -1) this.selectedProfiles.splice(idx, 1);
                  });
                }
              },
              triggerCleanup() {
                console.log('[Frontend] Cleanup button clicked');
                if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ —É–¥–∞–ª–∏—Ç –í–°–ï –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ, –Ω–æ –µ—â–µ –Ω–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç—ã. –ù–∞–∂–º–∏—Ç–µ –û–ö –¥–ª—è –æ—á–∏—Å—Ç–∫–∏.')) {
                  console.log('[Frontend] Cleanup cancelled by user');
                  return;
                }

                console.log('[Frontend] Sending cleanup request to POST /api/cleanup...');
                fetch('/api/cleanup', { method: 'POST' })
                  .then(response => response.json())
                  .then(data => {
                    console.log('[Frontend] Cleanup response:', data);
                    alert(data.message || '–û—á–∏—Å—Ç–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞!');
                  })
                  .catch(e => {
                    console.error('[Frontend] Cleanup error:', e);
                    alert('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –æ—á–∏—Å—Ç–∫–∏');
                  });
              },
              formatCron(cron) {
                if (!cron) return '–û—Ç–∫–ª—é—á–µ–Ω–æ';
                try {
                  const parts = cron.split(' ');
                  if (parts.length >= 2) {
                    const m = parts[0].padStart(2, '0');
                    const h = parts[1].padStart(2, '0');
                    return `${h}:${m}`;
                  }
                } catch (e) { }
                return cron;
              },
              applyBulkCategory() {
                if (!this.bulkThemeKey) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏!');
                if (this.selectedProfiles.length === 0) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª–∏!');

                const category = this.bulkThemeKey.toLowerCase().trim();

                let count = 0;
                this.config.profiles.forEach(p => {
                  if (this.selectedProfiles.includes(p.username)) {
                    p.theme_key = category;
                    count++;
                  }
                });

                this.saveConfig();
                this.selectedProfiles = []; // Clear selection
                this.bulkThemeKey = '';
                alert(`–£—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ –ø—Ä–æ—Ñ–∏–ª–µ–π: ${count}`);
              },
              this.selectedProfiles = []; // Clear selection
              this.bulkThemeKey = '';
              alert(`–£—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ –ø—Ä–æ—Ñ–∏–ª–µ–π: ${count}`);
              },
              async loadGlobalAnalytics() {
                this.analytics.loading = true;
                try {
                  const res = await fetch('/api/analytics/global');
                  const data = await res.json();
                  if (data.success && data.stats) {
                    this.analytics.date = data.stats.date;
                    this.analytics.platforms = data.stats.platforms || {};
                  }
                } catch (e) {
                   console.error('Failed to load global analytics', e);
                } finally {
                   this.analytics.loading = false;
                }
              },
              async refreshAnalytics() {
                 if(!confirm('–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–±–æ—Ä –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –¥–ª—è –≤—Å–µ—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π? –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è.')) return;
                 try {
                    await fetch('/api/analytics/refresh', { method: 'POST' });
                    alert('–°–±–æ—Ä –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∑–∞–ø—É—â–µ–Ω –≤ —Ñ–æ–Ω–µ. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ –ø–∞—Ä—É –º–∏–Ω—É—Ç.');
                 } catch(e) {
                    alert('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞: ' + e);
                 }
              },
              async loadLogs() {
                this.logsLoading = true;
                try {
                  const res = await fetch('/api/logs?lines=200');
                  const data = await res.json();

                  this.logsSuccess = data.success || false;
                  this.logsMessage = data.message || '';
                  this.logs = data.logs || [];
                } catch (e) {
                  this.logsSuccess = false;
                  this.logsMessage = e.message;
                  this.logs = [];
                } finally {
                  this.logsLoading = false;
                }
              }
            },
            watch: {
              logsAutoRefresh(newVal) {
                if (newVal) {
                  // Start auto-refresh
                  this.logsRefreshInterval = setInterval(() => {
                    if (this.currentTab === 'logs') {
                      this.loadLogs();
                    }
                  }, 3000);
                } else {
                  // Stop auto-refresh
                  if (this.logsRefreshInterval) {
                    clearInterval(this.logsRefreshInterval);
                    this.logsRefreshInterval = null;
                  }
                }
              },
              currentTab(newTab) {
                // Load logs when entering logs tab
                if (newTab === 'logs' && this.logs.length === 0) {
                  this.loadLogs();
                }
              }
            }
          }).mount('#app');
        </script>
</body>

</html>