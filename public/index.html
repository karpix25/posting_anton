<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (v1.1)</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Hide number input arrows */
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    input[type=number] {
      -moz-appearance: textfield;
    }
  </style>
</head>

<body class="bg-gray-100 text-gray-800">
  <div id="app" class="min-h-screen p-8">

    <!-- Header -->
    <div class="max-w-6xl mx-auto mb-8 flex justify-between items-center">
      <h1 class="text-3xl font-bold text-blue-600">üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –ö–æ–Ω—Ç–µ–Ω—Ç–∞</h1>
      <button @click="saveConfig" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded shadow">
        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
      </button>
    </div>

    <!-- Main Content -->
    <div class="max-w-6xl mx-auto bg-white rounded-lg shadow-lg overflow-hidden flex">

      <!-- Sidebar / Tabs -->
      <div class="w-64 bg-gray-50 border-r p-4 space-y-2">
        <button v-for="tab in tabs" :key="tab.id" @click="currentTab = tab.id"
          :class="['w-full text-left px-4 py-2 rounded', currentTab === tab.id ? 'bg-blue-100 text-blue-700 font-semibold' : 'hover:bg-gray-200']">
          {{ tab.name }}
        </button>
      </div>

      <!-- Tab Content -->
      <div class="flex-1 p-8">
        <div v-if="loading" class="text-center text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫...</div>

        <div v-else>

          <!-- DASHBOARD TAB -->
          <div v-if="currentTab === 'dashboard'">
            <h2 class="text-2xl font-bold mb-4">–°—Ç–∞—Ç—É—Å</h2>
            <div class="grid grid-cols-3 gap-4 mb-8">
              <div class="bg-blue-50 p-4 rounded border border-blue-100">
                <div class="text-sm text-gray-500">–°–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—É—Å–∫</div>
                <div class="text-lg font-mono">{{ config.cronSchedule }}</div>
              </div>
              <div class="bg-purple-50 p-4 rounded border border-purple-100">
                <div class="text-sm text-gray-500">–ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏</div>
                <div class="text-lg font-bold">{{ config.profiles?.length || 0 }}</div>
              </div>
              <div class="bg-indigo-50 p-4 rounded border border-indigo-100 flex flex-col justify-between">
                <div>
                  <div class="text-sm text-gray-500">–í–∏–¥–µ–æ –Ω–∞ –¥–∏—Å–∫–µ</div>
                  <div class="text-lg font-bold" v-if="stats">{{ stats.totalVideos }}</div>
                  <div class="text-lg font-bold text-gray-400" v-else>--</div>
                </div>
                <button @click="loadStats"
                  class="mt-2 text-xs bg-indigo-200 hover:bg-indigo-300 px-2 py-1 rounded text-indigo-800 self-start">
                  üîÑ Sync
                </button>
              </div>
            </div>

            <button @click="triggerRun(false)"
              class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded text-lg font-semibold">
              –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—é
            </button>
            <button @click="triggerRun(true)"
              class="bg-amber-500 hover:bg-amber-600 text-white px-6 py-3 rounded text-lg font-semibold"
              title="Only 1 post per platform (Safe Mode)">
              üß™ –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ (1 –ø–æ—Å—Ç)
            </button>
            <button @click="triggerCleanup"
              class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded text-lg font-semibold"
              title="–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç—ã">
              üóëÔ∏è –°–±—Ä–æ—Å
            </button>
          </div>
        </div>

        <!-- STATS TAB -->
        <div v-if="currentTab === 'stats'">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
            <button @click="loadStats(true)" class="text-sm bg-gray-200 px-3 py-1 rounded hover:bg-gray-300">üîÑ
              –û–±–Ω–æ–≤–∏—Ç—å</button>
          </div>

          <div v-if="statsLoading" class="text-center py-8 text-gray-500">–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫–∞...</div>
          <div v-else>
            <!-- Overview Cards -->
            <div class="grid grid-cols-2 gap-6 mb-8">
              <div class="bg-blue-50 p-6 rounded-lg border border-blue-100 text-center">
                <div class="text-gray-500 mb-1">–í—Å–µ–≥–æ –¥–æ—Å—Ç—É–ø–Ω–æ –≤–∏–¥–µ–æ</div>
                <div class="text-4xl font-bold text-blue-700">{{ stats.totalVideos }}</div>
                <div class="text-xs text-blue-400 mt-2">–ì–æ—Ç–æ–≤—ã –∫ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ (Yandex Disk)</div>
              </div>
              <div class="bg-green-50 p-6 rounded-lg border border-green-100 text-center">
                <div class="text-gray-500 mb-1">–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ –∏ —É–¥–∞–ª–µ–Ω–æ</div>
                <div class="text-4xl font-bold text-green-700">{{ stats.publishedCount }}</div>
                <div class="text-xs text-green-400 mt-2">–ó–∞ –≤—Å—ë –≤—Ä–µ–º—è</div>
              </div>
            </div>

            <!-- Statistics Summary Cards -->
            <div v-if="statsSummary" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
              <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg p-6 text-white shadow-lg">
                <div class="text-sm opacity-90">–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ</div>
                <div class="text-3xl font-bold mt-2">{{ statsSummary.published_total }}</div>
              </div>
              <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-lg p-6 text-white shadow-lg">
                <div class="text-sm opacity-90">–£–¥–∞–ª–µ–Ω–æ</div>
                <div class="text-3xl font-bold mt-2">{{ statsSummary.deleted_total }}</div>
              </div>
              <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg p-6 text-white shadow-lg">
                <div class="text-sm opacity-90">Instagram</div>
                <div class="text-3xl font-bold mt-2">{{ statsSummary.by_platform.instagram }}</div>
              </div>
              <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg p-6 text-white shadow-lg">
                <div class="text-sm opacity-90">TikTok + YouTube</div>
                <div class="text-3xl font-bold mt-2">{{ statsSummary.by_platform.tiktok +
                  statsSummary.by_platform.youtube }}</div>
              </div>
            </div>

            <!-- Categories Breakdown -->
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-xl font-bold">–†–∞–∑–±–∏–≤–∫–∞ –ø–æ {{ statsViewMode === 'category' ? '–ö–∞—Ç–µ–≥–æ—Ä–∏—è–º' : '–ê–≤—Ç–æ—Ä–∞–º' }}
              </h3>

              <div class="bg-gray-200 p-1 rounded-lg flex text-sm">
                <button @click="statsViewMode = 'category'"
                  :class="['px-3 py-1 rounded-md transition', statsViewMode === 'category' ? 'bg-white shadow text-blue-600 font-bold' : 'text-gray-600 hover:text-gray-800']">
                  –ü–æ –¢–µ–º–∞–º
                </button>
                <button @click="statsViewMode = 'author'"
                  :class="['px-3 py-1 rounded-md transition', statsViewMode === 'author' ? 'bg-white shadow text-blue-600 font-bold' : 'text-gray-600 hover:text-gray-800']">
                  –ü–æ –ê–≤—Ç–æ—Ä–∞–º
                </button>
              </div>
            </div>
            <div class="bg-white border rounded-lg overflow-hidden">
              <table class="w-full border-collapse mt-6">
                <thead class="bg-gray-100">
                  <tr>
                    <th class="text-left p-3 border-b">{{ statsHeader }}</th>
                    <th class="text-left p-3 border-b">–ü—Ä–æ—Ñ–∏–ª–∏</th>
                    <th class="text-right p-3 border-b w-32">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="item in currentStatsList" :key="item.name" class="border-b hover:bg-gray-50">
                    <td class="p-3 capitalize">{{ item.name }}</td>
                    <td class="p-3">
                      <div class="flex gap-2 flex-wrap">
                        <span v-for="profile in getProfilesForCategory(item.name)" :key="profile"
                          class="px-2 py-1 text-xs bg-blue-50 text-blue-700 rounded">
                          {{ profile }}
                        </span>
                        <span
                          v-if="!getProfilesForCategory(item.name) || getProfilesForCategory(item.name).length === 0"
                          class="text-gray-400 text-sm italic">
                          –ù–µ—Ç –ø—Ä–æ—Ñ–∏–ª–µ–π
                        </span>
                      </div>
                    </td>
                    <td class="p-3 text-right font-semibold">{{ item.count.toLocaleString() }}</td>
                  </tr>
                  <tr v-if="currentStatsList.length === 0">
                    <td colspan="3" class="p-4 text-center text-gray-400">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- SETTINGS TAB -->
        <div v-if="currentTab === 'settings'">
          <h2 class="text-2xl font-bold mb-4">–û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h2>

          <div class="mb-4">
            <label class="block mb-2 font-semibold">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ (Cron)</label>
            <input v-model="config.cronSchedule" class="w-full border p-2 rounded" placeholder="0 8 * * *">
          </div>

          <div class="mb-4">
            <label class="block mb-2 font-semibold">–ü–∞–ø–∫–∏ –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫–∞ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
            <input v-model="foldersInput" @input="updateFolders" class="w-full border p-2 rounded">
          </div>

          <div class="mb-4">
            <label class="block mb-2 font-semibold">–ù–∞ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –≤–ø–µ—Ä–µ–¥?</label>
            <input type="number" min="1" max="30" v-model.number="config.daysToGenerate"
              class="w-full border p-2 rounded" placeholder="1">
            <p class="text-xs text-gray-500 mt-1">1 = —Ç–æ–ª—å–∫–æ —Å–µ–≥–æ–¥–Ω—è. 7 = –Ω–µ–¥–µ–ª—è.</p>
          </div>

          <h3 class="text-xl font-bold mt-6 mb-4">–õ–∏–º–∏—Ç—ã –ø–ª–∞—Ç—Ñ–æ—Ä–º (–ø–æ—Å—Ç–æ–≤ –≤ –¥–µ–Ω—å –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å)</h3>
          <div class="grid grid-cols-3 gap-4">
            <div>
              <label>Instagram</label>
              <input type="number" v-model="config.limits.instagram" class="w-full border p-2 rounded">
            </div>
            <div>
              <label>TikTok</label>
              <input type="number" v-model="config.limits.tiktok" class="w-full border p-2 rounded">
            </div>
            <div>
              <label>YouTube</label>
              <input type="number" v-model="config.limits.youtube" class="w-full border p-2 rounded">
            </div>
          </div>
        </div>

        <!-- PROFILES TAB -->
        <div v-if="currentTab === 'profiles'">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold">–°–æ—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏</h2>
            <div class="space-x-2">
              <button @click="syncProfiles"
                class="text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded hover:bg-blue-200">üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å
                (UploadPost)</button>
              <button @click="fullResync"
                class="text-sm bg-red-100 text-red-700 px-3 py-1 rounded hover:bg-red-200 border border-red-300">
                ‚ö†Ô∏è –ü–æ–ª–Ω—ã–π –°–±—Ä–æ—Å (–°–∫–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ)
              </button>
              <button @click="addProfile" class="text-sm bg-gray-200 px-3 py-1 rounded hover:bg-gray-300">+ –î–æ–±–∞–≤–∏—Ç—å
                –ø—Ä–æ—Ñ–∏–ª—å</button>
            </div>
          </div>

          <!-- Active Profiles -->
          <div v-if="activeProfiles.length > 0">
            <div class="flex justify-between items-center mb-3 p-3 bg-gray-50 rounded">
              <button @click="showActiveProfiles = !showActiveProfiles"
                class="flex-1 text-left text-lg font-semibold hover:text-blue-600 flex items-center gap-2">
                <span>üü¢ –ê–∫—Ç–∏–≤–Ω—ã–µ –ü—Ä–æ—Ñ–∏–ª–∏ ({{ activeProfiles.length }})</span>
                <span class="text-xl">{{ showActiveProfiles ? '‚ñº' : '‚ñ∂' }}</span>
              </button>
              <div class="flex gap-2 text-sm" v-if="showActiveProfiles">
                <button @click="expandAllGroups(true)" class="text-blue-600 hover:underline">–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ</button>
                <span class="text-gray-300">|</span>
                <button @click="expandAllGroups(false)" class="text-blue-600 hover:underline">–°–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ</button>
              </div>
            </div>

            <!-- BULK ACTIONS BAR (Floating / Top) -->
            <div v-if="selectedProfiles.length > 0"
              class="sticky top-0 z-10 bg-blue-600 text-white p-4 rounded shadow-lg mb-4 flex justify-between items-center">
              <div class="font-bold">
                –í—ã–±—Ä–∞–Ω–æ –ø—Ä–æ—Ñ–∏–ª–µ–π: {{ selectedProfiles.length }}
              </div>
              <div class="flex items-center gap-2">
                <span>–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∫–æ –≤—Å–µ–º:</span>
                <select v-model="bulkThemeKey" class="p-1 px-2 rounded text-black w-40 border border-gray-300">
                  <option disabled value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>
                  <option v-for="theme in availableThemes" :key="theme" :value="theme">
                    {{ theme }}
                  </option>
                </select>
                <button @click="applyBulkCategory"
                  class="bg-white text-blue-600 font-bold px-4 py-1 rounded hover:bg-gray-100">
                  –ü—Ä–∏–º–µ–Ω–∏—Ç—å
                </button>

                <div class="border-l border-blue-400 pl-4 ml-2 flex items-center gap-2">
                  <span class="text-sm font-medium">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:</span>
                  <label class="inline-flex items-center cursor-pointer">
                    <input type="checkbox"
                      :checked="selectedProfiles.some(u => config.profiles.find(p => p.username === u)?.enabled !== false)"
                      @change="toggleBulkEnabled($event.target.checked)" class="sr-only peer">
                    <div
                      class="relative w-11 h-6 bg-blue-800 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-400">
                    </div>
                    <span class="ml-2 text-sm font-medium text-blue-100"
                      v-if="selectedProfiles.some(u => config.profiles.find(p => p.username === u)?.enabled !== false)">–í–ö–õ</span>
                    <span class="ml-2 text-sm font-medium text-blue-200" v-else>–í–´–ö–õ</span>
                  </label>
                </div>
                <button @click="selectedProfiles = []" class="ml-4 text-sm text-blue-200 hover:text-white underline">
                  –°–±—Ä–æ—Å–∏—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ
                </button>
              </div>
            </div>

            <div v-if="showActiveProfiles">
              <div v-for="(profiles, theme) in groupedActiveProfiles" :key="theme"
                class="mb-4 border rounded overflow-hidden">
                <!-- Group Header -->
                <div
                  class="bg-blue-50 p-3 font-semibold flex justify-between items-center hover:bg-blue-100 transition-colors">
                  <div class="flex items-center gap-3 flex-1">
                    <input type="checkbox" :checked="profiles.every(p => selectedProfiles.includes(p.username))"
                      @change="toggleGroupSelection(profiles, $event.target.checked)"
                      class="w-5 h-5 rounded cursor-pointer" title="–í—ã–±—Ä–∞—Ç—å –≤—Å—é –≥—Ä—É–ø–ø—É">

                    <div @click="toggleGroup(theme)" class="flex items-center gap-2 cursor-pointer flex-1">
                      <span>üìÅ {{ theme }}</span>
                      <span class="bg-blue-200 text-blue-800 text-xs px-2 py-1 rounded-full">{{ profiles.length
                        }}</span>
                    </div>
                  </div>
                  <span @click="toggleGroup(theme)" class="text-gray-500 cursor-pointer p-2">{{ expandedGroups[theme]
                    ? '‚ñº' : '‚ñ∂' }}</span>
                </div>

                <!-- Group Content (Table) -->
                <div v-show="expandedGroups[theme]" class="border-t">
                  <table class="w-full border-collapse">
                    <thead class="bg-gray-50 text-xs text-gray-500 uppercase">
                      <tr>
                        <th class="p-3 w-8"><input type="checkbox"
                            @change="toggleGroupSelection(profiles, $event.target.checked)"
                            :checked="profiles.every(p => selectedProfiles.includes(p.username))"></th>
                        <th class="text-left p-3 w-12"></th>
                        <th class="text-left p-3">–ü—Ä–æ—Ñ–∏–ª—å</th>
                        <th class="text-left p-3">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                        <th class="text-left p-3">–ü–ª–∞—Ç—Ñ–æ—Ä–º—ã</th>
                        <th class="text-left p-3 w-20">–õ–∏–º–∏—Ç</th>
                        <th class="text-center p-3 w-32">–î–µ–π—Å—Ç–≤–∏—è</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr v-for="profile in profiles" :key="profile.username" class="border-b hover:bg-gray-50"
                        :class="{'bg-blue-50': selectedProfiles.includes(profile.username)}">
                        <td class="p-3 text-center">
                          <input type="checkbox" :checked="selectedProfiles.includes(profile.username)"
                            @click="handleProfileSelect($event, profile, profiles)" class="w-4 h-4 cursor-pointer">
                        </td>
                        <td class="p-2 text-center text-xl" :title="'–ê–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å'">üü¢</td>
                        <td class="p-2 font-medium">
                          <input v-model="profile.username"
                            class="w-full border-b border-transparent hover:border-gray-300 p-1 bg-transparent"
                            placeholder="Username">
                        </td>
                        <td class="p-2">
                          <select v-model="profile.theme_key"
                            class="w-full border-b border-transparent hover:border-gray-300 p-1 bg-transparent text-sm">
                            <option value="" class="text-gray-400">–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                            <option v-for="theme in availableThemes" :key="theme" :value="theme">
                              {{ theme }}
                            </option>
                          </select>
                        </td>
                        <td class="p-2">
                          <div class="flex gap-1 flex-wrap">
                            <span v-for="platform in profile.platforms" :key="platform"
                              class="px-2 py-0.5 text-xs rounded border" :class="{
                                    'bg-pink-50 border-pink-200 text-pink-700': platform === 'instagram',
                                    'bg-blue-50 border-blue-200 text-blue-700': platform === 'tiktok',
                                    'bg-red-50 border-red-200 text-red-700': platform === 'youtube'
                                  }">
                              {{ platform }}
                            </span>
                            <span v-if="!profile.platforms || profile.platforms.length === 0"
                              class="text-gray-400 text-xs italic">
                              –ù–µ—Ç –ø–ª–∞—Ç—Ñ–æ—Ä–º
                            </span>
                            <span v-if="!profile.platforms || profile.platforms.length === 0"
                              class="text-gray-400 text-xs italic">
                              –ù–µ—Ç –ø–ª–∞—Ç—Ñ–æ—Ä–º
                            </span>
                          </div>
                        </td>
                        <td class="p-2">
                          <input type="number" min="0" max="50" v-model.number="profile.limit" placeholder="-"
                            class="w-16 border-b border-transparent hover:border-gray-300 p-1 bg-transparent text-center"
                            title="–õ–∏–º–∏—Ç –ø–æ—Å—Ç–æ–≤/–¥–µ–Ω—å (–ø—É—Å—Ç–æ = –≥–ª–æ–±–∞–ª—å–Ω—ã–π)">
                        </td>
                        <td class="p-2 text-center">
                          <label class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" :checked="profile.enabled !== false"
                              @change="toggleProfileEnabled(profile)" class="sr-only peer">
                            <div
                              class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600">
                            </div>
                          </label>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Disabled Profiles -->
          <div v-if="disabledProfiles.length > 0">
            <button @click="showDisabledProfiles = !showDisabledProfiles"
              class="w-full flex justify-between items-center text-lg font-semibold mb-3 p-3 bg-gray-50 hover:bg-gray-100 rounded text-gray-600">
              <span>‚ö´ –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ ({{ disabledProfiles.length }})</span>
              <span class="text-2xl">{{ showDisabledProfiles ? '‚ñº' : '‚ñ∂' }}</span>
            </button>
            <table v-if="showDisabledProfiles" class="w-full border-collapse opacity-60">
              <thead class="bg-gray-100">
                <tr>
                  <th class="text-left p-3 border-b w-12">–°—Ç–∞—Ç—É—Å</th>
                  <th class="text-left p-3 border-b">–ü—Ä–æ—Ñ–∏–ª—å</th>
                  <th class="text-left p-3 border-b">
                    –ö–∞—Ç–µ–≥–æ—Ä–∏—è/–¢–µ–º–∞
                    <span class="text-xs font-normal text-gray-500">(–Ω–∞–∑–≤–∞–Ω–∏–µ –ø–∞–ø–∫–∏ –∏–ª–∏ –≥—Ä—É–ø–ø—ã)</span>
                  </th>
                  <th class="text-left p-3 border-b">–ü–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ –ü–ª–∞—Ç—Ñ–æ—Ä–º—ã</th>
                  <th class="text-left p-3 border-b">–õ–∏–º–∏—Ç</th>
                  <th class="text-center p-3 border-b w-32">–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="profile in disabledProfiles" :key="profile.username" class="border-b hover:bg-gray-50">
                  <td class="p-2 text-center text-2xl" :title="'–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω'">‚ö´</td>
                  <td class="p-2 text-gray-500">{{ profile.username }}</td>
                  <td class="p-2 text-gray-500">{{ profile.theme_key }}</td>
                  <td class="p-2">
                    <div class="flex gap-2">
                      <span v-for="platform in profile.platforms" :key="platform"
                        class="px-2 py-1 text-xs rounded bg-gray-200 text-gray-600">
                        {{ platform === 'instagram' ? 'Instagram' : platform === 'tiktok' ? 'TikTok' : 'YouTube' }}
                      </span>
                    </div>
                  </td>
                  <td class="p-2 text-gray-400 text-center">
                    {{ profile.limit || '-' }}
                  </td>
                  <td class="p-2 text-center">
                    <label class="inline-flex items-center cursor-pointer">
                      <input type="checkbox" :checked="profile.enabled !== false"
                        @change="toggleProfileEnabled(profile)" class="sr-only peer">
                      <div
                        class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600">
                      </div>
                    </label>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- CLIENTS TAB -->
        <div v-if="currentTab === 'clients'">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold">–ö–ª–∏–µ–Ω—Ç—ã –∏ –ü—Ä–æ–º—Ç—ã (AI)</h2>
            <button @click="addClient" class="text-sm bg-gray-200 px-3 py-1 rounded hover:bg-gray-300">+ –î–æ–±–∞–≤–∏—Ç—å
              –∫–ª–∏–µ–Ω—Ç–∞</button>
          </div>

          <div v-for="(client, idx) in config.clients" :key="idx" class="border p-4 rounded mb-4 bg-gray-50">
            <div class="grid grid-cols-3 gap-4 mb-2">
              <div>
                <label class="text-sm text-gray-500 block">–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞ (–±—Ä–µ–Ω–¥)</label>
                <input v-model="client.name" class="w-full border p-2 rounded">
              </div>
              <div>
                <label class="text-sm text-gray-500 block">Regex –ø–∞–ø–∫–∏</label>
                <input v-model="client.regex" class="w-full border p-2 rounded font-mono">
              </div>
              <div>
                <label class="text-sm text-gray-500 block">–ö–≤–æ—Ç–∞ (–≤–∏–¥–µ–æ/–º–µ—Å—è—Ü)</label>
                <input v-model.number="client.quota" type="number" min="0" class="w-full border p-2 rounded"
                  placeholder="30">
                <div class="text-xs text-gray-400 mt-1">–°–∫–æ–ª—å–∫–æ –≤–∏–¥–µ–æ –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤ –º–µ—Å—è—Ü</div>
              </div>
            </div>
            <div>
              <label class="text-sm text-gray-500 block">AI –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º—Ç</label>
              <textarea v-model="client.prompt" class="w-full border p-2 rounded h-32 font-mono text-sm"></textarea>
            </div>
            <div class="text-right mt-2">
              <button @click="removeClient(idx)" class="text-red-500 text-sm hover:underline">–£–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</button>
            </div>
          </div>
        </div>


        <script>
          const { createApp } = Vue;

          createApp({
            data() {
              return {
                currentTab: 'dashboard',
                tabs: [
                  { id: 'dashboard', name: '–î–∞—à–±–æ—Ä–¥' },
                  { id: 'stats', name: '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞' },
                  { id: 'settings', name: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏' },
                  { id: 'profiles', name: '–ü—Ä–æ—Ñ–∏–ª–∏' },
                  { id: 'clients', name: 'AI –ö–ª–∏–µ–Ω—Ç—ã' }
                ],
                config: {
                  cronSchedule: '',
                  daysToGenerate: 1, // Default for safety
                  yandexFolders: [],
                  limits: { instagram: 0, tiktok: 0, youtube: 0 },
                  profiles: [],
                  clients: []
                },
                stats: {
                  totalVideos: 0,
                  publishedCount: 0,
                  byCategory: {},
                  byAuthor: {},
                  profilesByCategory: {}
                },
                statsSummary: null,
                loading: true,
                statsLoading: false,
                statsViewMode: 'category', // 'category' or 'author'
                foldersInput: '',
                newThemeKey: '',
                showActiveProfiles: true,    // Collapsible - active by default
                showDisabledProfiles: false,  // Collapsible - collapsed by default
                expandedGroups: {}, // For accordion view
                selectedProfiles: [], // List of selected usernames for bulk actions
                lastSelected: null, // For Shift+Click
                bulkThemeKey: '', // Model for bulk edit input
              }
            },
            async mounted() {
              await this.loadConfig();
              this.loadStats();
              this.fetchStatsSummary();
            },
            computed: {
              currentStatsList() {
                const source = this.statsViewMode === 'author' ? (this.stats.byAuthor || {}) : (this.stats.byCategory || {});
                return Object.entries(source)
                  .map(([name, count]) => ({ name, count }))
                  .sort((a, b) => a.name.localeCompare(b.name));
              },
              statsHeader() {
                return this.statsViewMode === 'category' ? '–ö–∞—Ç–µ–≥–æ—Ä–∏—è / –ü–∞–ø–∫–∞' : '–ò–º—è –ê–≤—Ç–æ—Ä–∞ / –ü–∞–ø–∫–∞';
              },
              activeProfiles() {
                if (!this.config.profiles) return [];
                return this.config.profiles.filter(p => p.enabled !== false);
              },
              disabledProfiles() {
                if (!this.config.profiles) return [];
                return this.config.profiles.filter(p => p.enabled === false);
              },
              groupedActiveProfiles() {
                const groups = {};
                this.activeProfiles.forEach(p => {
                  // Create a consistent key
                  const key = (p.theme_key || '–ë–µ–∑ —Ç–µ–º—ã').toLowerCase().trim();
                  // Capitalize for display
                  const displayKey = key.charAt(0).toUpperCase() + key.slice(1);

                  if (!groups[displayKey]) groups[displayKey] = [];
                  groups[displayKey].push(p);
                });

                // Sort keys alphabetically
                return Object.keys(groups).sort().reduce((acc, key) => {
                  acc[key] = groups[key];
                  return acc;
                }, {});
              },
              availableThemes() {
                // Source strictly from config.themeAliases (which is auto-populated from Yandex Stats)
                if (this.config && this.config.themeAliases) {
                  return Object.keys(this.config.themeAliases).sort();
                }
                return [];
              }
            },
            methods: {
              getProfilesForCategory(categoryName) {
                // keys in profilesByCategory are always lowercase/trimmed
                const key = categoryName.toLowerCase().trim();
                return this.stats.profilesByCategory[key] || [];
              },
              async loadStats() {
                this.statsLoading = true;
                try {
                  const res = await fetch('/api/stats');
                  if (res.ok) {
                    this.stats = await res.json();

                    // Auto-persist found folders as themes
                    let changed = false;
                    if (!this.config.themeAliases) this.config.themeAliases = {};

                    const foundFolders = Object.keys(this.stats.byCategory || {});
                    foundFolders.forEach(folder => {
                      // Use exact folder name as key
                      // If not exists, add it.
                      // We don't delete old ones automatically to preserve history? 
                      // User said "upsert or add new". Cleaning old ones isn't explicitly requested but safe to keep.
                      if (!this.config.themeAliases[folder]) {
                        this.config.themeAliases[folder] = [folder]; // Default alias is itself
                        changed = true;
                      }
                    });

                    if (changed) {
                      this.saveConfig();
                      // No alert needed, just silent save
                    }
                  }
                } catch (e) {
                  console.error('Failed to load stats', e);
                } finally {
                  this.statsLoading = false;
                }
              },
              async fetchStatsSummary() {
                try {
                  const res = await fetch('/api/stats/summary');
                  const data = await res.json();
                  if (data.success) {
                    this.statsSummary = data.stats;
                  }
                } catch (error) {
                  console.error('Failed to fetch stats summary:', error);
                }
              },
              async loadConfig() {
                this.loading = true;
                try {
                  const res = await fetch('/api/config');
                  if (!res.ok) {
                    throw new Error(`Server returned ${res.status}`);
                  }
                  const data = await res.json();
                  // Ensure structure and merge with defaults
                  this.config = {
                    profiles: [],
                    clients: [],
                    limits: { instagram: 10, tiktok: 10, youtube: 2 },
                    yandexFolders: [],
                    ...this.config, // Keep existing if any? No, we want server data.
                    ...data // Overwrite with server data
                  };

                  // Explicitly ensure deep objects if missing from server data
                  if (!this.config.profiles) this.config.profiles = [];
                  if (!this.config.clients) this.config.clients = [];
                  if (!this.config.limits) this.config.limits = { instagram: 10, tiktok: 10, youtube: 2 };

                  this.foldersInput = (this.config.yandexFolders || []).join(', ');
                } catch (e) {
                  console.error('[UI] Failed to load config:', e);
                  // alert('Failed to load config (using defaults)');
                  // Keep default config structure
                } finally {
                  this.loading = false;
                }
              },
              async saveConfig() {
                try {
                  await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.config)
                  });
                  alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!');
                } catch (e) {
                  alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                }
              },
              async triggerRun(testMode = false) {
                // Ensure current state is saved before running
                await this.saveConfig();

                if (!confirm(testMode ? '–ó–∞–ø—É—Å—Ç–∏—Ç—å –≤ –¢–ï–°–¢–û–í–û–ú —Ä–µ–∂–∏–º–µ (–ø–æ 1 –ø–æ—Å—Ç—É –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É)?' : '–ó–∞–ø—É—Å—Ç–∏—Ç—å –ü–û–õ–ù–´–ô —Ü–∏–∫–ª –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏?')) return;
                try {
                  await fetch('/api/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ testMode })
                  });
                  alert('–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –∑–∞–ø—É—â–µ–Ω–∞ –≤ —Ñ–æ–Ω–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞.');
                } catch (e) {
                  alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å');
                }
              },
              async syncProfiles() {
                console.log('[UI] Sync button clicked');
                try {
                  const res = await fetch('/api/profiles/sync');
                  const data = await res.json();
                  console.log('[UI] Sync response:', data);

                  if (data.success && data.profiles) {
                    let addedCount = 0;

                    data.profiles.forEach(apiProfile => {
                      // Find existing profile by username
                      const existingProfile = this.config.profiles.find(p => p.username === apiProfile.username);

                      // Get platforms from API (keys of social_accounts where value is not empty)
                      const platforms = Object.entries(apiProfile.social_accounts || {})
                        .filter(([_, value]) => !!value) // Filter out empty strings/nulls
                        .map(([key]) => key);

                      if (platforms.length === 0) platforms.push('instagram'); // Default fallback

                      if (existingProfile) {
                        // Update existing profile's platforms if needed (merge or overwrite)
                        // We overwrite to ensure it reflects current state
                        existingProfile.platforms = platforms;
                      } else {
                        // Add new profile
                        this.config.profiles.push({
                          username: apiProfile.username,
                          theme_key: '',
                          platforms: platforms,
                          enabled: true
                        });
                        addedCount++;
                      }
                    });

                    alert(`–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –î–æ–±–∞–≤–ª–µ–Ω–æ –Ω–æ–≤—ã—Ö: ${addedCount}. –û–±–Ω–æ–≤–ª–µ–Ω—ã –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã —É —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö.`);
                    this.saveConfig();
                  } else {
                    console.error('[UI] Sync failed:', data.error);
                    alert('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                  }
                } catch (e) {
                  console.error('[UI] Fetch error:', e);
                  alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª–∏ (—Å–º. –∫–æ–Ω—Å–æ–ª—å)');
                }
              },
              async fullResync() {
                if (!confirm("–í–ù–ò–ú–ê–ù–ò–ï! \n–≠—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π (Smart, Toplash –∏ –¥—Ä.) –¥–ª—è –ø—Ä–æ—Ñ–∏–ª–µ–π.\n–°–ø–∏—Å–æ–∫ –ø—Ä–æ—Ñ–∏–ª–µ–π –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞—á–∏—Å—Ç–æ –∏–∑ UploadPost.\n\n–í—ã —É–≤–µ—Ä–µ–Ω—ã?")) return;

                this.config.profiles = []; // Clear all local profiles
                await this.syncProfiles(); // Fetch fresh
                this.saveConfig(); // Save the new clean state
              },
              updateFolders() {
                this.config.yandexFolders = this.foldersInput.split(',').map(s => s.trim()).filter(Boolean);
              },
              addProfile() {
                this.config.profiles.push({
                  username: '',
                  theme_key: '',
                  platforms: [] // Start with empty array, user will check boxes
                });
              },
              toggleProfileEnabled(profile) {
                // Toggle between enabled=true and enabled=false
                profile.enabled = profile.enabled === false ? true : false;
                this.saveConfig();
              },
              removeProfile(idx) {
                this.config.profiles.splice(idx, 1);
              },
              toggleBulkEnabled(enable) {
                this.selectedProfiles.forEach(username => {
                  const profile = this.config.profiles.find(p => p.username === username);
                  if (profile) {
                    profile.enabled = enable;
                  }
                });
                this.saveConfig();
                this.selectedProfiles = [];
                // No alert, just UI update
              },
              addClient() {
                this.config.clients.push({ name: 'New Client', regex: '', prompt: '' });
              },
              removeClient(idx) {
                this.config.clients.splice(idx, 1);
              },
              updateAliases(key, value) {
                const arr = value.split(',').map(s => s.trim()).filter(s => s.length > 0);
                this.config.themeAliases[key] = arr;
              },
              addThemeKey() {
                if (!this.newThemeKey) return;
                const key = this.newThemeKey.toLowerCase().trim();
                if (this.config.themeAliases[key]) {
                  alert('–ì—Ä—É–ø–ø–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!');
                  return;
                }
                this.config.themeAliases[key] = [key];
                this.newThemeKey = '';
              },
              deleteThemeKey(key) {
                if (confirm(`–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É '${key}'?`)) {
                  delete this.config.themeAliases[key];
                }
              },
              deleteTheme(key) {
                // Alias for deleteThemeKey for backward compatibility if template calls it
                this.deleteThemeKey(key);
              },
              toggleGroup(key) {
                this.expandedGroups[key] = !this.expandedGroups[key];
              },
              expandAllGroups(expand) {
                const keys = Object.keys(this.groupedActiveProfiles);
                keys.forEach(key => {
                  this.expandedGroups[key] = expand;
                });
              },
              handleProfileSelect(event, profile, groupProfiles) {
                const username = profile.username;
                const isSelected = this.selectedProfiles.includes(username);
                // Standard checkbox behavior toggles value. 
                // But since we use @click, we need to know what the NEW state will be.
                // If it was selected, it will become unselected.
                // Note: browser checkbox toggles visually on click immediately.
                // We just need to sync our array.

                let targetState = !isSelected;

                // Use event.shiftKey to detect range selection
                if (event.shiftKey && this.lastSelected) {
                  const lastIdx = groupProfiles.findIndex(p => p.username === this.lastSelected);
                  const currIdx = groupProfiles.findIndex(p => p.username === username);

                  if (lastIdx !== -1 && currIdx !== -1) {
                    const start = Math.min(lastIdx, currIdx);
                    const end = Math.max(lastIdx, currIdx);

                    const range = groupProfiles.slice(start, end + 1);

                    range.forEach(p => {
                      const idx = this.selectedProfiles.indexOf(p.username);
                      if (targetState && idx === -1) {
                        this.selectedProfiles.push(p.username);
                      } else if (!targetState && idx !== -1) {
                        this.selectedProfiles.splice(idx, 1);
                      }
                    });
                  } else {
                    this.toggleSelectionSingle(username, targetState);
                  }
                } else {
                  this.toggleSelectionSingle(username, targetState);
                }

                this.lastSelected = username;
              },
              toggleSelectionSingle(username, state) {
                const idx = this.selectedProfiles.indexOf(username);
                if (state && idx === -1) {
                  this.selectedProfiles.push(username);
                } else if (!state && idx !== -1) {
                  this.selectedProfiles.splice(idx, 1);
                }
              },
              toggleGroupSelection(profiles, checked) {
                if (checked) {
                  // Add all profiles in group to selection
                  profiles.forEach(p => {
                    if (!this.selectedProfiles.includes(p.username)) {
                      this.selectedProfiles.push(p.username);
                    }
                  });
                } else {
                  // Remove all profiles in group from selection
                  profiles.forEach(p => {
                    const idx = this.selectedProfiles.indexOf(p.username);
                    if (idx > -1) this.selectedProfiles.splice(idx, 1);
                  });
                }
              },
              triggerCleanup() {
                console.log('[Frontend] Cleanup button clicked');
                if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ —É–¥–∞–ª–∏—Ç –í–°–ï –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ, –Ω–æ –µ—â–µ –Ω–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç—ã. –ù–∞–∂–º–∏—Ç–µ –û–ö –¥–ª—è –æ—á–∏—Å—Ç–∫–∏.')) {
                  console.log('[Frontend] Cleanup cancelled by user');
                  return;
                }

                console.log('[Frontend] Sending cleanup request to POST /api/cleanup...');
                fetch('/api/cleanup', { method: 'POST' })
                  .then(response => response.json())
                  .then(data => {
                    console.log('[Frontend] Cleanup response:', data);
                    alert(data.message || '–û—á–∏—Å—Ç–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞!');
                  })
                  .catch(e => {
                    console.error('[Frontend] Cleanup error:', e);
                    alert('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –æ—á–∏—Å—Ç–∫–∏');
                  });
              },
              applyBulkCategory() {
                if (!this.bulkThemeKey) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏!');
                if (this.selectedProfiles.length === 0) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª–∏!');

                const category = this.bulkThemeKey.toLowerCase().trim();

                let count = 0;
                this.config.profiles.forEach(p => {
                  if (this.selectedProfiles.includes(p.username)) {
                    p.theme_key = category;
                    count++;
                  }
                });

                this.saveConfig();
                this.selectedProfiles = []; // Clear selection
                this.bulkThemeKey = '';
                alert(`–£—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ –ø—Ä–æ—Ñ–∏–ª–µ–π: ${count}`);
              }
            }
          }).mount('#app');
        </script>
</body>

</html>