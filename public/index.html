<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (v1.1)</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 text-gray-800">
  <div id="app" class="min-h-screen p-8">

    <!-- Header -->
    <div class="max-w-6xl mx-auto mb-8 flex justify-between items-center">
      <h1 class="text-3xl font-bold text-blue-600">üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –ö–æ–Ω—Ç–µ–Ω—Ç–∞</h1>
      <button @click="saveConfig" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded shadow">
        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
      </button>
    </div>

    <!-- Main Content -->
    <div class="max-w-6xl mx-auto bg-white rounded-lg shadow-lg overflow-hidden flex">

      <!-- Sidebar / Tabs -->
      <div class="w-64 bg-gray-50 border-r p-4 space-y-2">
        <button v-for="tab in tabs" :key="tab.id" @click="currentTab = tab.id"
          :class="['w-full text-left px-4 py-2 rounded', currentTab === tab.id ? 'bg-blue-100 text-blue-700 font-semibold' : 'hover:bg-gray-200']">
          {{ tab.name }}
        </button>
      </div>

      <!-- Tab Content -->
      <div class="flex-1 p-8">
        <div v-if="loading" class="text-center text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫...</div>

        <div v-else>

          <!-- DASHBOARD TAB -->
          <div v-if="currentTab === 'dashboard'">
            <h2 class="text-2xl font-bold mb-4">–°—Ç–∞—Ç—É—Å</h2>
            <div class="grid grid-cols-3 gap-4 mb-8">
              <div class="bg-blue-50 p-4 rounded border border-blue-100">
                <div class="text-sm text-gray-500">–°–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—É—Å–∫</div>
                <div class="text-lg font-mono">{{ config.cronSchedule }}</div>
              </div>
              <div class="bg-purple-50 p-4 rounded border border-purple-100">
                <div class="text-sm text-gray-500">–ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏</div>
                <div class="text-lg font-bold">{{ config.profiles?.length || 0 }}</div>
              </div>
              <div class="bg-indigo-50 p-4 rounded border border-indigo-100 flex flex-col justify-between">
                <div>
                  <div class="text-sm text-gray-500">–í–∏–¥–µ–æ –Ω–∞ –¥–∏—Å–∫–µ</div>
                  <div class="text-lg font-bold" v-if="stats">{{ stats.totalVideos }}</div>
                  <div class="text-lg font-bold text-gray-400" v-else>--</div>
                </div>
                <button @click="loadStats"
                  class="mt-2 text-xs bg-indigo-200 hover:bg-indigo-300 px-2 py-1 rounded text-indigo-800 self-start">
                  üîÑ Sync
                </button>
              </div>
            </div>

            <div class="flex gap-4">
              <button @click="triggerRun(false)"
                class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded text-lg font-semibold">
                –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—é
              </button>
              <button @click="triggerRun(true)"
                class="bg-amber-500 hover:bg-amber-600 text-white px-6 py-3 rounded text-lg font-semibold"
                title="Only 1 post per platform (Safe Mode)">
                üß™ –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ (1 –ø–æ—Å—Ç)
              </button>
            </div>
          </div>

          <!-- STATS TAB -->
          <div v-if="currentTab === 'stats'">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-2xl font-bold">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
              <button @click="loadStats"
                class="text-sm bg-gray-200 px-3 py-1 rounded hover:bg-gray-300">–û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>

            <div v-if="statsLoading" class="text-center py-8 text-gray-500">–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫–∞...</div>
            <div v-else>
              <!-- Overview Cards -->
              <div class="grid grid-cols-2 gap-6 mb-8">
                <div class="bg-blue-50 p-6 rounded-lg border border-blue-100 text-center">
                  <div class="text-gray-500 mb-1">–í—Å–µ–≥–æ –¥–æ—Å—Ç—É–ø–Ω–æ –≤–∏–¥–µ–æ</div>
                  <div class="text-4xl font-bold text-blue-700">{{ stats.totalVideos }}</div>
                  <div class="text-xs text-blue-400 mt-2">–ì–æ—Ç–æ–≤—ã –∫ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ (Yandex Disk)</div>
                </div>
                <div class="bg-green-50 p-6 rounded-lg border border-green-100 text-center">
                  <div class="text-gray-500 mb-1">–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ –∏ —É–¥–∞–ª–µ–Ω–æ</div>
                  <div class="text-4xl font-bold text-green-700">{{ stats.publishedCount }}</div>
                  <div class="text-xs text-green-400 mt-2">–ó–∞ –≤—Å—ë –≤—Ä–µ–º—è</div>
                </div>
              </div>

              <!-- Statistics Summary Cards -->
              <div v-if="statsSummary" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg p-6 text-white shadow-lg">
                  <div class="text-sm opacity-90">–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ</div>
                  <div class="text-3xl font-bold mt-2">{{ statsSummary.published_total }}</div>
                </div>
                <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-lg p-6 text-white shadow-lg">
                  <div class="text-sm opacity-90">–£–¥–∞–ª–µ–Ω–æ</div>
                  <div class="text-3xl font-bold mt-2">{{ statsSummary.deleted_total }}</div>
                </div>
                <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg p-6 text-white shadow-lg">
                  <div class="text-sm opacity-90">Instagram</div>
                  <div class="text-3xl font-bold mt-2">{{ statsSummary.by_platform.instagram }}</div>
                </div>
                <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg p-6 text-white shadow-lg">
                  <div class="text-sm opacity-90">TikTok + YouTube</div>
                  <div class="text-3xl font-bold mt-2">{{ statsSummary.by_platform.tiktok +
                    statsSummary.by_platform.youtube }}</div>
                </div>
              </div>

              <!-- Categories Breakdown -->
              <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">–†–∞–∑–±–∏–≤–∫–∞ –ø–æ {{ statsViewMode === 'category' ? '–ö–∞—Ç–µ–≥–æ—Ä–∏—è–º' : '–ê–≤—Ç–æ—Ä–∞–º' }}
                </h3>

                <div class="bg-gray-200 p-1 rounded-lg flex text-sm">
                  <button @click="statsViewMode = 'category'"
                    :class="['px-3 py-1 rounded-md transition', statsViewMode === 'category' ? 'bg-white shadow text-blue-600 font-bold' : 'text-gray-600 hover:text-gray-800']">
                    –ü–æ –¢–µ–º–∞–º
                  </button>
                  <button @click="statsViewMode = 'author'"
                    :class="['px-3 py-1 rounded-md transition', statsViewMode === 'author' ? 'bg-white shadow text-blue-600 font-bold' : 'text-gray-600 hover:text-gray-800']">
                    –ü–æ –ê–≤—Ç–æ—Ä–∞–º
                  </button>
                </div>
              </div>
              <div class="bg-white border rounded-lg overflow-hidden">
                <table class="w-full">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="text-left p-3 border-b">{{ statsHeader }}</th>
                      <th class="text-right p-3 border-b">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="item in currentStatsList" :key="item.name"
                      class="border-b last:border-0 hover:bg-gray-50">
                      <td class="p-3 capitalize">{{ item.name }}</td>
                      <td class="p-3 text-right font-mono">{{ item.count }}</td>
                    </tr>
                    <tr v-if="currentStatsList.length === 0">
                      <td colspan="2" class="p-4 text-center text-gray-400">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- SETTINGS TAB -->
          <div v-if="currentTab === 'settings'">
            <h2 class="text-2xl font-bold mb-4">–û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h2>

            <div class="mb-4">
              <label class="block mb-2 font-semibold">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ (Cron)</label>
              <input v-model="config.cronSchedule" class="w-full border p-2 rounded" placeholder="0 8 * * *">
            </div>

            <div class="mb-4">
              <label class="block mb-2 font-semibold">–ü–∞–ø–∫–∏ –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫–∞ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
              <input v-model="foldersInput" @input="updateFolders" class="w-full border p-2 rounded">
            </div>

            <h3 class="text-xl font-bold mt-6 mb-4">–õ–∏–º–∏—Ç—ã –ø–ª–∞—Ç—Ñ–æ—Ä–º (–ø–æ—Å—Ç–æ–≤ –≤ –¥–µ–Ω—å –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å)</h3>
            <div class="grid grid-cols-3 gap-4">
              <div>
                <label>Instagram</label>
                <input type="number" v-model="config.limits.instagram" class="w-full border p-2 rounded">
              </div>
              <div>
                <label>TikTok</label>
                <input type="number" v-model="config.limits.tiktok" class="w-full border p-2 rounded">
              </div>
              <div>
                <label>YouTube</label>
                <input type="number" v-model="config.limits.youtube" class="w-full border p-2 rounded">
              </div>
            </div>
          </div>

          <!-- PROFILES TAB -->
          <div v-if="currentTab === 'profiles'">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-2xl font-bold">–°–æ—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏</h2>
              <div class="space-x-2">
                <button @click="syncProfiles"
                  class="text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded hover:bg-blue-200">üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å
                  (UploadPost)</button>
                <button @click="addProfile" class="text-sm bg-gray-200 px-3 py-1 rounded hover:bg-gray-300">+ –î–æ–±–∞–≤–∏—Ç—å
                  –ø—Ä–æ—Ñ–∏–ª—å</button>
              </div>
            </div>

            <table class="w-full border-collapse">
              <thead class="bg-gray-100">
                <tr>
                  <th class="text-left p-3 border-b">–ü—Ä–æ—Ñ–∏–ª—å</th>
                  <th class="text-left p-3 border-b">–ü–∞–ø–∫–∞ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏</th>
                  <th class="text-left p-3 border-b">–ü–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ –ü–ª–∞—Ç—Ñ–æ—Ä–º—ã</th>
                  <th class="text-center p-3 border-b w-24">–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="(profile, idx) in config.profiles" :key="idx" class="border-b hover:bg-gray-50">
                  <td class="p-2"><input v-model="profile.username" class="w-full border p-1 rounded"
                      placeholder="e.g. Toplash1"></td>
                  <td class="p-2"><input v-model="profile.theme_key" class="w-full border p-1 rounded"
                      placeholder="–Ω–∞–ø—Ä: toplash, smart, pokypki..."></td>
                  <td class="p-2">
                    <div class="flex gap-2">
                      <span v-for="platform in profile.platforms" :key="platform" class="px-2 py-1 text-xs rounded"
                        :class="{
                          'bg-pink-100 text-pink-700': platform === 'instagram',
                          'bg-blue-100 text-blue-700': platform === 'tiktok',
                          'bg-red-100 text-red-700': platform === 'youtube'
                        }">
                        {{ platform === 'instagram' ? 'Instagram' : platform === 'tiktok' ? 'TikTok' : 'YouTube' }}
                      </span>
                      <span v-if="!profile.platforms || profile.platforms.length === 0" class="text-gray-400 text-sm">
                        –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö
                      </span>
                    </div>
                  </td>
                  <td class="p-2 text-center">
                    <button @click="removeProfile(idx)" class="text-red-500 hover:text-red-700">–£–¥–∞–ª–∏—Ç—å</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- CLIENTS TAB -->
          <div v-if="currentTab === 'clients'">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-2xl font-bold">–ö–ª–∏–µ–Ω—Ç—ã –∏ –ü—Ä–æ–º—Ç—ã (AI)</h2>
              <button @click="addClient" class="text-sm bg-gray-200 px-3 py-1 rounded hover:bg-gray-300">+ –î–æ–±–∞–≤–∏—Ç—å
                –∫–ª–∏–µ–Ω—Ç–∞</button>
            </div>

            <div v-for="(client, idx) in config.clients" :key="idx" class="border p-4 rounded mb-4 bg-gray-50">
              <div class="grid grid-cols-2 gap-4 mb-2">
                <div>
                  <label class="text-sm text-gray-500 block">–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞</label>
                  <input v-model="client.name" class="w-full border p-2 rounded">
                </div>
                <div>
                  <label class="text-sm text-gray-500 block">Regex –ø–∞–ø–∫–∏</label>
                  <input v-model="client.regex" class="w-full border p-2 rounded font-mono">
                </div>
              </div>
              <div>
                <label class="text-sm text-gray-500 block">AI –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º—Ç</label>
                <textarea v-model="client.prompt" class="w-full border p-2 rounded h-32 font-mono text-sm"></textarea>
              </div>
              <div class="text-right mt-2">
                <button @click="removeClient(idx)" class="text-red-500 text-sm hover:underline">–£–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</button>
              </div>
            </div>
          </div>


          <!-- THEMES TAB -->
          <div v-if="currentTab === 'themes'">
            <h2 class="text-2xl font-bold mb-4">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¢–µ–º (Mapping)</h2>
            <p class="text-gray-500 mb-6 text-sm">
              –ü—Ä–∏–≤—è–∑–∫–∞ –Ω–∞–∑–≤–∞–Ω–∏–π –ø–∞–ø–æ–∫ (Aliases) –∫ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º –≥—Ä—É–ø–ø–∞–º (Keys).
              –ï—Å–ª–∏ –ø—É—Ç—å –≤–∏–¥–µ–æ –∏–ª–∏ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–æ–¥–µ—Ä–∂–∏—Ç alias, –æ–Ω–æ –±—É–¥–µ—Ç –æ—Ç–Ω–µ—Å–µ–Ω–æ –∫ —ç—Ç–æ–π –≥—Ä—É–ø–ø–µ.
            </p>

            <div class="space-y-6">
              <div v-for="(aliases, key) in config.themeAliases" :key="key" class="bg-gray-50 p-4 rounded border">
                <div class="flex justify-between items-center mb-2">
                  <h3 class="font-bold text-lg capitalize text-blue-800">{{ key }}</h3>
                  <button @click="deleteThemeKey(key)" class="text-red-400 hover:text-red-600 text-xs">–£–¥–∞–ª–∏—Ç—å
                    –≥—Ä—É–ø–ø—É</button>
                </div>
                <div>
                  <label class="block text-xs text-gray-400 mb-1">–°–∏–Ω–æ–Ω–∏–º—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
                  <input type="text" :value="aliases.join(', ')" @input="updateAliases(key, $event.target.value)"
                    class="w-full p-2 border rounded focus:ring focus:ring-blue-200"
                    placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: smart, smartbox...">
                </div>
              </div>

              <!-- Add New Group -->
              <div class="bg-white p-4 rounded border border-dashed border-gray-300">
                <h4 class="font-semibold text-gray-600 mb-2">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –≥—Ä—É–ø–ø—É</h4>
                <div class="flex gap-2">
                  <input v-model="newThemeKey" placeholder="–ò–º—è –≥—Ä—É–ø–ø—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä: adidas)"
                    class="flex-1 p-2 border rounded">
                  <button @click="addThemeKey"
                    class="bg-gray-200 hover:bg-gray-300 px-4 rounded text-gray-700">–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
              </div>
            </div>

            <div class="mt-8 p-4 bg-yellow-50 rounded border border-yellow-100 text-sm text-yellow-800">
              ‚ö†Ô∏è <b>–í–∞–∂–Ω–æ:</b> –ò–∑–º–µ–Ω–µ–Ω–∏—è –∑–¥–µ—Å—å –≤–ª–∏—è—é—Ç –Ω–∞ —Ç–æ, –∫–∞–∫ –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –ø–∞–ø–∫–∏ –∏ –ø—Ä–æ—Ñ–∏–ª–∏.
              –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫, –≤–æ–∑–º–æ–∂–Ω–æ, –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const { createApp } = Vue;

    createApp({
      data() {
        return {
          currentTab: 'dashboard',
          tabs: [
            { id: 'dashboard', name: '–î–∞—à–±–æ—Ä–¥' },
            { id: 'stats', name: '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞' },
            { id: 'settings', name: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏' },
            { id: 'profiles', name: '–ü—Ä–æ—Ñ–∏–ª–∏' },
            { id: 'clients', name: 'AI –ü—Ä–æ–º—Ç—ã' },
            { id: 'themes', name: '–¢–µ–º—ã –∏ –ì—Ä—É–ø–ø—ã' }
          ],
          config: {
            cronSchedule: '',
            yandexFolders: [],
            limits: { instagram: 0, tiktok: 0, youtube: 0 },
            profiles: [],
            clients: []
          },
          stats: {
            totalVideos: 0,
            publishedCount: 0,
            byCategory: {},
            byAuthor: {}
          },
          statsSummary: null,
          loading: true,
          statsLoading: false,
          statsViewMode: 'category', // 'category' or 'author'
          foldersInput: '',
          newThemeKey: ''
        }
      },
      async mounted() {
        await this.loadConfig();
        this.loadStats();
        this.fetchStatsSummary();
      },
      computed: {
        currentStatsList() {
          const source = this.statsViewMode === 'author' ? (this.stats.byAuthor || {}) : (this.stats.byCategory || {});
          return Object.entries(source)
            .map(([name, count]) => ({ name, count }))
            .sort((a, b) => a.name.localeCompare(b.name));
        },
        statsHeader() {
          return this.statsViewMode === 'category' ? '–ö–∞—Ç–µ–≥–æ—Ä–∏—è / –ü–∞–ø–∫–∞' : '–ò–º—è –ê–≤—Ç–æ—Ä–∞ / –ü–∞–ø–∫–∞';
        }
      },
      methods: {
        async loadStats() {
          this.statsLoading = true;
          try {
            const res = await fetch('/api/stats');
            if (res.ok) {
              this.stats = await res.json();
            }
          } catch (e) {
            console.error('Failed to load stats', e);
          } finally {
            this.statsLoading = false;
          }
        },
        async fetchStatsSummary() {
          try {
            const res = await fetch('/api/stats/summary');
            const data = await res.json();
            if (data.success) {
              this.statsSummary = data.stats;
            }
          } catch (error) {
            console.error('Failed to fetch stats summary:', error);
          }
        },
        async loadConfig() {
          this.loading = true;
          try {
            const res = await fetch('/api/config');
            if (!res.ok) {
              throw new Error(`Server returned ${res.status}`);
            }
            const data = await res.json();
            // Ensure structure and merge with defaults
            this.config = {
              profiles: [],
              clients: [],
              limits: { instagram: 10, tiktok: 10, youtube: 2 },
              yandexFolders: [],
              ...this.config, // Keep existing if any? No, we want server data.
              ...data // Overwrite with server data
            };

            // Explicitly ensure deep objects if missing from server data
            if (!this.config.profiles) this.config.profiles = [];
            if (!this.config.clients) this.config.clients = [];
            if (!this.config.limits) this.config.limits = { instagram: 10, tiktok: 10, youtube: 2 };

            this.foldersInput = (this.config.yandexFolders || []).join(', ');
          } catch (e) {
            console.error('[UI] Failed to load config:', e);
            // alert('Failed to load config (using defaults)');
            // Keep default config structure
          } finally {
            this.loading = false;
          }
        },
        async saveConfig() {
          try {
            await fetch('/api/config', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(this.config)
            });
            alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!');
          } catch (e) {
            alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
          }
        },
        async triggerRun(testMode = false) {
          if (!confirm(testMode ? '–ó–∞–ø—É—Å—Ç–∏—Ç—å –≤ –¢–ï–°–¢–û–í–û–ú —Ä–µ–∂–∏–º–µ (–ø–æ 1 –ø–æ—Å—Ç—É –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É)?' : '–ó–∞–ø—É—Å—Ç–∏—Ç—å –ü–û–õ–ù–´–ô —Ü–∏–∫–ª –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏?')) return;
          try {
            await fetch('/api/run', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ testMode })
            });
            alert('–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –∑–∞–ø—É—â–µ–Ω–∞ –≤ —Ñ–æ–Ω–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞.');
          } catch (e) {
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å');
          }
        },
        async syncProfiles() {
          console.log('[UI] Sync button clicked');
          try {
            const res = await fetch('/api/profiles/sync');
            const data = await res.json();
            console.log('[UI] Sync response:', data);

            if (data.success && data.profiles) {
              let addedCount = 0;
              // Merge logic: Add if username (API ID) doesn't exist
              data.profiles.forEach(apiProfile => {
                const exists = this.config.profiles.find(p => p.username === apiProfile.username);

                // API returns structured social_accounts. We might want to create entries for each *connected* platform 
                // OR just add the user and let user choose platform. 
                // Simpler: Just add the user. Logic handles separate entries per platform usually if we want distinct queues.
                // But here 'username' in config acts as the API 'user' ID.
                // So we just ensure this 'user' ID is in our list.

                if (!exists) {
                  // Add a generic entry, default to instagram? Or maybe add all detected platforms?
                  // Let's check social_accounts keys
                  const platforms = Object.keys(apiProfile.social_accounts || {});
                  if (platforms.length > 0) {
                    platforms.forEach(plat => {
                      // Check if we have this user+platform combination? 
                      // Current config structure is array of { username, platform, ... }
                      const exactMatch = this.config.profiles.find(p => p.username === apiProfile.username && p.platform === plat);
                      if (!exactMatch) {
                        this.config.profiles.push({
                          username: apiProfile.username,
                          platform: plat,
                          theme_key: '' // User must fill this to match folders
                        });
                        addedCount++;
                      }
                    });
                  } else {
                    // No specific platforms found, just add generic
                    this.config.profiles.push({
                      username: apiProfile.username,
                      platform: 'instagram',
                      theme_key: ''
                    });
                    addedCount++;
                  }
                }
              });

              alert(`–ü—Ä–æ—Ñ–∏–ª–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã! –î–æ–±–∞–≤–ª–µ–Ω–æ: ${addedCount}.`);
              // Auto-save? Maybe let user save.
            } else {
              console.error('[UI] Sync failed:', data.error);
              alert('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
          } catch (e) {
            console.error('[UI] Fetch error:', e);
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª–∏ (—Å–º. –∫–æ–Ω—Å–æ–ª—å)');
          }
        },
        updateFolders() {
          this.config.yandexFolders = this.foldersInput.split(',').map(s => s.trim()).filter(Boolean);
        },
        addProfile() {
          this.config.profiles.push({
            username: '',
            theme_key: '',
            platforms: [] // Start with empty array, user will check boxes
          });
        },
        removeProfile(idx) {
          this.config.profiles.splice(idx, 1);
        },
        addClient() {
          this.config.clients.push({ name: 'New Client', regex: '', prompt: '' });
        },
        removeClient(idx) {
          this.config.clients.splice(idx, 1);
        },
        updateAliases(key, value) {
          const arr = value.split(',').map(s => s.trim()).filter(s => s.length > 0);
          this.config.themeAliases[key] = arr;
        },
        addThemeKey() {
          if (!this.newThemeKey) return;
          const key = this.newThemeKey.toLowerCase().trim();
          if (this.config.themeAliases[key]) {
            alert('–ì—Ä—É–ø–ø–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!');
            return;
          }
          this.config.themeAliases[key] = [key];
          this.newThemeKey = '';
        },
        deleteThemeKey(key) {
          if (confirm(`–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É '${key}'?`)) {
            delete this.config.themeAliases[key];
          }
        }
      }
    }).mount('#app');
  </script>
</body>

</html>